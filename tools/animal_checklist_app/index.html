<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Rescue Compliance Checklist</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json"><meta name="theme-color" content="#0ea5e9">
    
    <!-- Custom Styles -->
    <style>
        /* Define CSS variables for colors, fonts, and spacing */
        :root {
            --font-sans: 'Inter', sans-serif;
            --spacing-4: 1rem;
            --spacing-8: 2rem;
            --scrollbar-track-bg: #e2e8f0; /* slate-200 */
            --scrollbar-thumb-bg: #94a3b8; /* slate-400 */
            --scrollbar-thumb-hover-bg: #64748b; /* slate-500 */
            --checkbox-bg: #fff;
            --checkbox-border: #cbd5e1; /* slate-300 */
            --checkbox-checked-border: #0ea5e9; /* sky-500 */
            --checkbox-checkmark-color: #0ea5e9; /* sky-500 */
            --modal-overlay-bg: rgba(15, 23, 42, 0.6); /* slate-900 with opacity */
        }

        /* Dark mode overrides */
        .dark {
            --scrollbar-track-bg: #334155; /* slate-700 */
            --scrollbar-thumb-bg: #64748b; /* slate-500 */
            --scrollbar-thumb-hover-bg: #94a3b8; /* slate-400 */
            --checkbox-bg: #334155; /* slate-700 */
            --checkbox-border: #475569; /* slate-600 */
            --checkbox-checked-border: #38bdf8; /* sky-400 */
            --checkbox-checkmark-color: #38bdf8; /* sky-400 */
        }

        /* --- Base & Font Styles --- */
        body {
            font-family: var(--font-sans);
        }

        /* --- Custom Scrollbar for Checklist Items --- */
        #checklist-items-container::-webkit-scrollbar {
            width: 8px;
        }
        #checklist-items-container::-webkit-scrollbar-track {
            background: var(--scrollbar-track-bg);
            border-radius: 4px;
        }
        #checklist-items-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb-bg);
            border-radius: 4px;
        }
        #checklist-items-container::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover-bg);
        }

        /* --- Custom Checkbox Appearance --- */
        .custom-checkbox {
            appearance: none;
            background-color: var(--checkbox-bg);
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.25em;
            height: 1.25em;
            border: 0.15em solid var(--checkbox-border);
            border-radius: 0.25em;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: 120ms all ease-in-out;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--checkbox-checkmark-color);
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            border-color: var(--checkbox-checked-border);
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
        .custom-checkbox:focus-visible {
            outline: max(2px, 0.15em) solid var(--checkbox-checked-border);
            outline-offset: max(2px, 0.15em);
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: var(--modal-overlay-bg);
            padding-top: 60px;
            backdrop-filter: blur(4px); /* Blur background */
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            margin: 5% auto;
            padding: var(--spacing-8);
            width: 90%;
            max-width: 550px; /* Increased width for summary */
            border-radius: 0.75rem; /* 12px */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Collapsible Category Styles --- */
        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .category-block.expanded .category-content {
            max-height: 2000px; /* Large enough to not clip content */
        }
        .category-toggle-icon {
            transition: transform 0.3s ease-in-out;
        }
        .category-block.expanded .category-toggle-icon {
            transform: rotate(90deg);
        }

        /* --- Spinner Animation --- */
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- Summary Modal Content Styles --- */
        #summary-content h4 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #summary-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        #summary-content li {
            margin-bottom: 0.25rem;
        }
        #summary-content strong {
            font-weight: 600;
        }
        #summary-content p {
            margin-bottom: 0.75rem;
        }


        /* --- Print Styles --- */
        @media print {
            .dark {
                --tw-bg-opacity: 1 !important;
                background-color: rgb(255 255 255 / var(--tw-bg-opacity)) !important;
                color: #000 !important;
            }
             .dark body, .dark #app-container, .dark #checklist-view, .dark .category-block, .dark textarea {
                 background-color: #fff !important;
                 color: #000 !important;
                 border-color: #ccc !important;
            }
             .dark #checklist-title, .dark .category-title, .dark .item-text, .dark a {
                 color: #000 !important;
            }
            body {
                font-family: serif;
                color: #000;
                background-color: #fff;
            }
            #app-container, #user-info {
                max-width: 100%;
                margin: 0;
                padding: 10px;
                box-shadow: none;
                border: none;
            }
            header, .action-buttons-container, .list-view-actions, #status-message, .modal, #search-container, .contextual-tool-button, #dark-mode-toggle, .edit-button, .delete-button, .add-item-button, .add-category-button, .attachment-actions, .file-input-wrapper, .category-toggle-icon, .category-actions, #external-tools-section {
                display: none !important;
            }
            #checklist-view {
                display: block !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }
            .category-content {
                max-height: none !important; /* Ensure content is visible for printing */
                overflow: visible !important;
            }
            #checklist-title-container {
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            #checklist-title {
                font-size: 22pt !important;
            }
            #org-name-input-print-header {
                display: block;
                font-size: 16pt;
                font-weight: bold;
                margin-top: 5px;
            }
            #org-name-input, #back-to-list-btn {
                display: none !important;
            }
            .category-block {
                border: 1px solid #ccc !important;
                padding: 10px !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            .category-title {
                font-size: 14pt !important;
                border-bottom: 1px solid #666;
                padding-bottom: 5px;
                margin-bottom: 10px;
            }
            .checklist-item {
                border-bottom: 1px dotted #ccc !important;
                padding: 8px 0 !important;
                page-break-inside: avoid;
            }
            input[type="checkbox"] {
                display: inline-block !important;
                vertical-align: top;
                margin-top: 4px;
            }
            .custom-checkbox {
                display: none !important;
            }
            .item-text {
                font-size: 11pt !important;
            }
            textarea {
                display: block !important;
                border: 1px solid #ddd !important;
                font-size: 10pt !important;
                resize: none !important;
                min-height: 30px;
                -webkit-print-color-adjust: exact;
            }
            a {
                text-decoration: none !important;
                color: #000 !important;
            }
            a:not(.no-print-url)::after {
                content: " (" attr(href) ")";
                font-size: 9pt;
            }
            .link-placeholder::after {
                content: "";
            }
        }
    </style>
    <!-- Theme Initialization Script -->
    <script>
        // This script runs before the body renders to prevent Flash of Unstyled Content (FOUC)
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-300 transition-colors duration-300">

    <main id="app-container" class="relative max-w-5xl mx-auto p-4 md:p-8">

        <!-- Dark Mode Toggle Button -->
        <div class="absolute top-4 right-4 z-20">
            <button id="dark-mode-toggle" class="p-2 rounded-full bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 transition-colors" aria-label="Toggle dark mode">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>

        <!-- User Info Display -->
        <div id="user-info" class="mb-4 p-3 bg-sky-100 dark:bg-sky-900/50 border border-sky-200 dark:border-sky-800 text-sky-800 dark:text-sky-300 rounded-lg text-sm text-center hidden">
            <p><strong>Status:</strong> <span id="auth-status">Initializing...</span></p>
            <p class="mt-1"><strong>User ID:</strong> <span id="user-id" class="font-mono break-all"></span></p>
        </div>

        <!-- List View -->
        <section id="list-view">
            <header class="mb-8 text-center">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-800 dark:text-slate-200">Rescue Compliance</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2 text-lg">Your cloud-synced checklists for ensuring animal welfare standards.</p>
            </header>

            <nav class="list-view-actions mb-6 flex flex-col sm:flex-row gap-3">
                <button id="new-checklist-btn" class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Start a new checklist">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                    <span>Start New</span>
                </button>
                <button id="import-checklist-btn" class="w-full sm:w-auto bg-slate-600 hover:bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Import a shared checklist">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    <span>Import Shared</span>
                </button>
            </nav>

            <div id="search-container" class="mb-8 relative">
                <label for="search-input" class="sr-only">Search by organization name</label>
                <input type="text" id="search-input" placeholder="Search by organization name..." class="w-full p-4 pl-12 border border-slate-300 dark:border-slate-600 dark:bg-slate-800 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow dark:placeholder-slate-400">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 dark:text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </div>
            
            <!-- External Tools Section -->
            <div id="external-tools-section" class="mb-8">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-4 border-b border-slate-300 dark:border-slate-700 pb-2">External Resources</h2>
                <div id="external-tools-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Tool cards will be generated by JS -->
                </div>
            </div>

            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-4 border-b border-slate-300 dark:border-slate-700 pb-2">My Checklists</h2>
            <div id="no-checklists-message" class="text-center py-16 bg-white dark:bg-slate-800 rounded-lg shadow-sm hidden">
                 <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 mx-auto text-slate-300 dark:text-slate-600 mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <p class="text-2xl font-semibold text-slate-700 dark:text-slate-300">No checklists found.</p>
                <p class="text-slate-500 dark:text-slate-400">Click "Start New" to begin, or "Import Shared" to add one from a colleague.</p>
            </div>

            <div id="saved-checklists-container" class="space-y-4">
                <!-- Saved checklist cards will be inserted here -->
            </div>
        </section>

        <!-- Checklist View (Hidden by default) -->
        <section id="checklist-view" class="hidden bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-lg">
            <header class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                <div id="checklist-title-container" class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <button id="back-to-list-btn" class="text-sky-600 dark:text-sky-400 hover:text-sky-800 dark:hover:text-sky-300 font-semibold flex items-center space-x-1.5 group mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                            <span>Back to List</span>
                        </button>
                        <h2 id="checklist-title" class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-200">New Checklist</h2>
                        <span id="org-name-input-print-header" class="hidden print:block"></span>
                    </div>
                </div>
                 <div class="mt-6">
                    <label for="org-name-input" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Rescue Organization Name</label>
                    <input type="text" id="org-name-input" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-900 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow dark:placeholder-slate-400" placeholder="e.g., Happy Paws Rescue">
                    <p id="org-name-error" class="text-red-500 dark:text-red-400 text-sm mt-1 hidden">Organization name cannot be empty.</p>
                </div>
            </header>

            <div id="checklist-items-container" class="space-y-6"></div>

            <button id="add-category-btn" class="mt-6 w-full bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                <span>Add New Category</span>
            </button>

            <div class="action-buttons-container mt-8 pt-6 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center gap-4">
                <button id="delete-checklist-btn" class="hidden w-full sm:w-auto text-red-600 dark:text-red-500 hover:text-white hover:bg-red-600 dark:hover:bg-red-500 font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 border border-red-500 dark:border-red-500 hover:border-red-600 dark:hover:border-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    <span>Delete</span>
                </button>

                <div class="flex flex-col sm:flex-row sm:justify-end gap-3 flex-wrap">
                     <button id="generate-summary-btn" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-5 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <span>✨</span>
                        <span>Generate Summary</span>
                    </button>
                     <button id="share-checklist-btn" class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-5 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367-2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                        <span>Share</span>
                    </button>
                     <button id="copy-checklist-btn" class="w-full sm:w-auto bg-slate-200 hover:bg-slate-300 text-slate-700 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-3 px-5 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <span>Copy as Text</span>
                    </button>
                     <button id="print-checklist-btn" class="w-full sm:w-auto bg-slate-200 hover:bg-slate-300 text-slate-700 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-3 px-5 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm-8-14h14M5 7h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2z" /></svg>
                        <span>Print</span>
                    </button>
                     <button id="save-checklist-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 transform hover:-translate-y-0.5 disabled:opacity-50">
                        <span id="save-button-text">Save</span>
                        <svg id="save-spinner" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden spinner" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M4 12a8 8 0 018-8v0a8 8 0 018 8v0a8 8 0 01-8 8v0a8 8 0 01-8-8v0z" /></svg>
                    </button>
                </div>
            </div>
            <div id="status-message" class="mt-4 text-center font-medium"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-400 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <h3 id="modal-title" class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Are you sure?</h3>
            <p id="modal-message" class="mb-8 text-slate-500 dark:text-slate-400">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367-2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Share this Checklist</h3>
            <p class="mb-4 text-slate-500 dark:text-slate-400">Give this ID to another user so they can import a read-only copy of this checklist.</p>
            <div class="p-3 bg-slate-100 dark:bg-slate-700 rounded-lg font-mono text-slate-700 dark:text-slate-200 text-center break-words border border-slate-200 dark:border-slate-600 mb-6" id="share-id-display"></div>
            <div class="flex justify-center space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Close</button>
                <button id="share-modal-copy-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Copy ID</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
             <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-4 text-center">Import Shared Checklist</h3>
             <label for="import-id-input" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Enter Share ID:</label>
             <input type="text" id="import-id-input" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-900 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:placeholder-slate-400" placeholder="Paste the Share ID here">
             <div id="import-status-message" class="mt-3 text-center text-sm font-medium"></div>
            <div class="flex justify-center space-x-4 mt-6">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <button id="import-modal-confirm-btn" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Import</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
            <h3 id="edit-modal-title" class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-4 text-center">Edit</h3>
            <label id="edit-modal-label" for="edit-modal-input" class="sr-only">New value</label>
            <input type="text" id="edit-modal-input" class="w-full p-3 border border-slate-300 dark:border-slate-600 dark:bg-slate-900 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:placeholder-slate-400" placeholder="">
            <p id="edit-modal-error" class="text-red-500 dark:text-red-400 text-sm mt-1 hidden"></p>
            <div class="flex justify-center space-x-4 mt-6">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <button id="edit-modal-save-btn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Gemini Summary Modal -->
    <div id="summary-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">✨ AI-Generated Summary</h3>
                <button data-dismiss="modal" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="summary-content-container" class="max-h-[60vh] overflow-y-auto p-4 bg-slate-50 dark:bg-slate-900/50 rounded-md">
                <div id="summary-loader" class="text-center py-8">
                    <svg class="h-8 w-8 spinner mx-auto text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M4 12a8 8 0 018-8v0a8 8 0 018 8v0a8 8 0 01-8 8v0a8 8 0 01-8-8v0z" /></svg>
                    <p class="mt-2 text-slate-500 dark:text-slate-400">Analyzing your checklist...</p>
                </div>
                <div id="summary-content" class="prose dark:prose-invert max-w-none"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="summary-copy-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg transition-colors">Copy Text</button>
            </div>
        </div>
    </div>

    <!-- External Link Modals -->
    <div id="ein-lookup-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Open IRS Search Tool</h3>
            <p class="mb-8 text-slate-500 dark:text-slate-400">The official IRS tool will be opened in a new browser tab.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <a href="https://apps.irs.gov/app/eos/" target="_blank" rel="noopener noreferrer" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors inline-flex items-center justify-center no-print-url">
                    Continue to IRS.gov
                </a>
            </div>
        </div>
    </div>
    <div id="propublica-lookup-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Open ProPublica Nonprofit Explorer</h3>
            <p class="mb-8 text-slate-500 dark:text-slate-400">The ProPublica Nonprofit Explorer website will be opened in a new browser tab.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <a href="https://projects.propublica.org/nonprofits/" target="_blank" rel="noopener noreferrer" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors inline-flex items-center justify-center no-print-url">
                    Continue to ProPublica
                </a>
            </div>
        </div>
    </div>
     <div id="bbb-scam-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Open BBB Scam Tracker</h3>
            <p class="mb-8 text-slate-500 dark:text-slate-400">The Better Business Bureau's website will be opened in a new browser tab.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <a href="https://www.bbb.org/scamtracker/lookupscam" target="_blank" rel="noopener noreferrer" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors inline-flex items-center justify-center no-print-url">
                    Continue to BBB.org
                </a>
            </div>
        </div>
    </div>
    <div id="nasco-reg-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Open State Regulator List</h3>
            <p class="mb-8 text-slate-500 dark:text-slate-400">The NASCO website will be opened in a new browser tab.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <a href="https://www.nasconet.org/resources/state-government/" target="_blank" rel="noopener noreferrer" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors inline-flex items-center justify-center no-print-url">
                    Continue to NASCOnet.org
                </a>
            </div>
        </div>
    </div>
    <div id="aphis-lookup-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Open APHIS Search Tool</h3>
            <p class="mb-8 text-slate-500 dark:text-slate-400">The USDA APHIS search tool will be opened in a new browser tab.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <a href="https://aphis.my.site.com/PublicSearchTool/s/" target="_blank" rel="noopener noreferrer" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors inline-flex items-center justify-center no-print-url">
                    Continue to APHIS
                </a>
            </div>
        </div>
    </div>
    <div id="charitynav-lookup-modal" class="modal">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-lg text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-2 rounded-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-2">Open Charity Navigator</h3>
            <p class="mb-8 text-slate-500 dark:text-slate-400">The Charity Navigator website will be opened in a new browser tab.</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button data-dismiss="modal" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold py-3 px-6 rounded-lg transition-colors">Cancel</button>
                <a href="https://www.charitynavigator.org/" target="_blank" rel="noopener noreferrer" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors inline-flex items-center justify-center no-print-url">
                    Continue to Charity Navigator
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Application Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, deleteObject, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCSLAD2acFHCmf8bkJwQx_puLcb-HARyJE",
            authDomain: "rescue-compliance-app.firebaseapp.com",
            projectId: "rescue-compliance-app",
            storageBucket: "rescue-compliance-app.appspot.com",
            messagingSenderId: "354094080932",
            appId: "1:354094080932:web:7c9aeb9b0036e6542d5731",
            measurementId: "G-CL6TNFWL0L"
        };

        // --- App State & Firebase References ---
        let db, auth, storage;
        let currentChecklistData = null;
        let checklistUnsubscribe = null;
        let userId = null;
        let isAuthReady = false;
        const ui = {}; // To be populated with DOM elements
        let confirmAction = null;
        let saveTimeout = null; // For debouncing save actions

        // --- App Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-animal-rescue-app';
        const checklistMasterTemplate = [
            { id: "cat_fed_state", name: "Federal & State Compliance", isCustom: false, items: [
                { id: "fed_irs_status", text: "IRS 501(c)(3) status verified?", link: "https://apps.irs.gov/app/eos/", linkText: "IRS Search", modalId: "ein-lookup-modal", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "fed_form_990", text: "IRS Form 990 accessible & reviewed?", link: "https://projects.propublica.org/nonprofits/", linkText: "ProPublica Search", modalId: "propublica-lookup-modal", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "fed_aphis_license", text: "APHIS license status verified (if applicable)?", link: "https://aphis.my.site.com/PublicSearchTool/s/", linkText: "APHIS Search", modalId: "aphis-lookup-modal", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "state_charity_reg", text: "Registered with State Charity Officials?", link: "https://www.nasconet.org/resources/state-government/", linkText: "NASCO Directory", modalId: "nasco-reg-modal", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "state_local_licenses", text: "Necessary state/local animal shelter/rescue licenses obtained?", isCustom: false, attachments: [], notes: "", checked: false }
            ]},
            { id: "cat_operational_trans", name: "Operational Transparency", isCustom: false, items: [
                { id: "op_legal_dba_name", text: "Legal name and DBA (Doing Business As) are clearly stated?", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "op_contact_info", text: "Verifiable contact information (phone/email) is available and responsive?", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "op_website_mission", text: "Website clearly states mission, programs, and animal welfare practices?", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "op_board_list", text: "A list of the Board of Directors is publicly available?", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "op_adoption_process", text: "Adoption process is clearly documented and transparent?", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "op_sourcing_policy", text: "Animal sourcing policy (where animals come from) is clear?", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "op_medical_records", text: "Comprehensive medical records (vaccinations, spay/neuter) are provided with adoptions?", isCustom: false, attachments: [], notes: "", checked: false }
            ]},
            { id: "cat_reputation_acc", name: "Reputation & Accountability", isCustom: false, items: [
                { id: "rep_bbb_rating", text: "Better Business Bureau (BBB) rating checked for unresolved complaints?", link: "https://www.bbb.org/scamtracker/lookupscam", linkText: "BBB Scam Tracker", modalId: "bbb-scam-modal", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "rep_watchdog_sites", text: "Charity watchdog sites (e.g., Charity Navigator, GuideStar) reviewed?", link: "https://www.charitynavigator.org/", linkText: "Charity Navigator", modalId: "charitynav-lookup-modal", isCustom: false, attachments: [], notes: "", checked: false },
                { id: "rep_news_archives", text: "News archives and search engines checked for significant negative press or legal issues?", isCustom: false, attachments: [], notes: "", checked: false }
            ]}
        ];

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            cacheDOMElements();
            setupTheme();
            renderExternalTools();

            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
                    // Show a less disruptive warning if config is missing, allowing UI to render.
                    console.warn("Firebase configuration is missing or incomplete. Functionality will be limited.");
                    ui.authStatus.textContent = "Offline Mode: Firebase not configured.";
                    ui.userInfo.classList.remove('hidden');
                    ui.newChecklistBtn.disabled = true;
                    ui.importChecklistBtn.disabled = true;
                } else {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    storage = getStorage(app);
                    setupAuthListener();
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                const errorHtml = `<div class="p-4 bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 rounded-lg">
                    <h3 class="font-bold">Application Error</h3><p class="text-sm mt-1">${error.message}</p></div>`;
                ui.appContainer.innerHTML = errorHtml;
                return;
            }

            attachEventListeners();
        }

        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            helpers.applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            ui.darkModeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                helpers.applyTheme(isDark ? 'light' : 'dark');
            });
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isAuthReady = true;
                    userId = user.uid;
                    ui.authStatus.textContent = "Authenticated";
                    ui.userId.textContent = userId;
                    ui.userInfo.classList.remove('hidden');
                    ui.newChecklistBtn.disabled = false;
                    ui.importChecklistBtn.disabled = false;
                    listenForChecklists();
                    helpers.showView('list');
                } else {
                    isAuthReady = false;
                    userId = null;
                    ui.authStatus.textContent = "Not Authenticated";
                    ui.userId.textContent = "";
                    ui.userInfo.classList.remove('hidden');
                    ui.newChecklistBtn.disabled = true;
                    ui.importChecklistBtn.disabled = true;
                    if (checklistUnsubscribe) checklistUnsubscribe();
                    renderListView([]);
                }
            });

            signInAnonymously(auth).catch(error => {
                console.error("Anonymous authentication failed: ", error);
                ui.authStatus.textContent = `Auth Failed: ${error.message}`;
            });
        }

        function cacheDOMElements() {
            const ids = [
                'app-container', 'list-view', 'checklist-view', 'new-checklist-btn', 'import-checklist-btn', 'back-to-list-btn', 
                'save-checklist-btn', 'delete-checklist-btn', 'share-checklist-btn', 'print-checklist-btn', 'copy-checklist-btn', 
                'add-category-btn', 'dark-mode-toggle', 'sun-icon', 'moon-icon', 'org-name-input', 'org-name-input-print-header', 
                'org-name-error', 'checklist-items-container', 'checklist-title', 'saved-checklists-container', 'search-input', 
                'no-checklists-message', 'status-message', 'user-info', 'auth-status', 'user-id', 'confirmation-modal', 
                'modal-title', 'modal-message', 'modal-confirm-btn', 'share-modal', 'share-id-display', 
                'share-modal-copy-btn', 'import-modal', 'import-id-input', 'import-status-message', 
                'import-modal-confirm-btn', 'edit-modal', 'edit-modal-title', 'edit-modal-label', 'edit-modal-input', 
                'edit-modal-error', 'edit-modal-save-btn', 'save-button-text', 'save-spinner',
                'generate-summary-btn', 'summary-modal', 'summary-content', 'summary-loader', 'summary-copy-btn',
                'external-tools-grid',
                'ein-lookup-modal', 'propublica-lookup-modal', 'bbb-scam-modal', 'nasco-reg-modal', 'aphis-lookup-modal', 'charitynav-lookup-modal'
            ];
            ids.forEach(id => { ui[id.replace(/-(\w)/g, (match, p1) => p1.toUpperCase())] = document.getElementById(id); });
        }

        function attachEventListeners() {
            ui.newChecklistBtn.addEventListener('click', () => { if(isAuthReady) renderChecklistForm(); });
            ui.backToListBtn.addEventListener('click', () => { helpers.showView('list'); filterAndRenderListView(); });
            ui.saveChecklistBtn.addEventListener('click', () => handleSaveChecklist(true)); // Force immediate save
            ui.deleteChecklistBtn.addEventListener('click', handleDeleteChecklist);
            ui.printChecklistBtn.addEventListener('click', () => {
                ui.orgNameInputPrintHeader.textContent = ui.orgNameInput.value.trim() || "Untitled Checklist";
                window.print();
            });
            ui.copyChecklistBtn.addEventListener('click', handleCopyChecklistText);
            ui.shareChecklistBtn.addEventListener('click', handleShareChecklist);
            ui.importChecklistBtn.addEventListener('click', () => {
                if(isAuthReady) {
                    ui.importIdInput.value = '';
                    ui.importStatusMessage.textContent = '';
                    helpers.openModal(ui.importModal);
                }
            });
            ui.generateSummaryBtn.addEventListener('click', handleGenerateSummary);
            ui.externalToolsGrid.addEventListener('click', (event) => {
                const toolCard = event.target.closest('.tool-card');
                if(toolCard) {
                    const modalId = toolCard.dataset.modalId;
                    const modal = document.getElementById(modalId);
                    if (modal) helpers.openModal(modal);
                }
            });

            ui.searchInput.addEventListener('input', filterAndRenderListView);
            ui.orgNameInput.addEventListener('input', () => {
                ui.checklistTitle.textContent = ui.orgNameInput.value.trim() || "New Checklist";
                handleSaveChecklist(); // Debounced save
            });
            ui.addCategoryBtn.addEventListener('click', addCategory);

            ui.checklistItemsContainer.addEventListener('click', handleChecklistContainerClick);
            ui.checklistItemsContainer.addEventListener('input', handleChecklistContainerInput);
            ui.checklistItemsContainer.addEventListener('change', handleChecklistContainerChange);

            ui.modalConfirmBtn.addEventListener('click', () => confirmAction?.());
            ui.shareModalCopyBtn.addEventListener('click', () => helpers.copyToClipboard(ui.shareIdDisplay.textContent, ui.shareModalCopyBtn, 'ID Copied!', 'Copy ID'));
            ui.importModalConfirmBtn.addEventListener('click', handleImportConfirm);
            ui.summaryCopyBtn.addEventListener('click', () => {
                const textToCopy = ui.summaryContent.innerText;
                helpers.copyToClipboard(textToCopy, ui.summaryCopyBtn, 'Copied!', 'Copy Text');
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (event) => { if (event.target === modal) helpers.closeModal(modal); });
                modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                    btn.addEventListener('click', () => helpers.closeModal(modal));
                });
            });
        }

        // --- Helper Functions ---
        const helpers = {
            showView: (viewToShow) => {
                ui.listView.classList.toggle('hidden', viewToShow !== 'list');
                ui.checklistView.classList.toggle('hidden', viewToShow !== 'checklist');
                window.scrollTo(0, 0);
            },
            showStatus: (element, message, type = 'success', duration = 3000) => {
                if (!element) return;
                const colors = { success: 'text-green-600', info: 'text-sky-600', error: 'text-red-600' };
                const darkColors = { success: 'dark:text-green-400', info: 'dark:text-sky-400', error: 'dark:text-red-400' };
                element.textContent = message;
                element.className = `mt-4 text-center font-medium ${colors[type] || colors.info} ${darkColors[type] || darkColors.info}`;
                if (duration !== null) {
                    setTimeout(() => { element.textContent = ''; }, duration);
                }
            },
            openModal: (modalElement) => { if (modalElement) modalElement.style.display = 'block'; },
            closeModal: (modalElement) => { if (modalElement) modalElement.style.display = 'none'; },
            openConfirmationModal: (title, message, onConfirm) => {
                ui.modalTitle.textContent = title;
                ui.modalMessage.textContent = message;
                confirmAction = () => {
                    onConfirm();
                    helpers.closeModal(ui.confirmationModal);
                };
                helpers.openModal(ui.confirmationModal);
            },
            _editModalSaveHandler: null,
            openEditModal: (config) => {
                const { title, label, placeholder, currentValue, onSave, validationFn = (val) => val.trim() !== '' } = config;
                ui.editModalTitle.textContent = title;
                ui.editModalLabel.textContent = label;
                ui.editModalInput.placeholder = placeholder;
                ui.editModalInput.value = currentValue;
                ui.editModalError.classList.add('hidden');

                if (helpers._editModalSaveHandler) ui.editModalSaveBtn.removeEventListener('click', helpers._editModalSaveHandler);
                
                helpers._editModalSaveHandler = () => {
                    const newValue = ui.editModalInput.value.trim();
                    if (validationFn(newValue)) {
                        onSave(newValue);
                        helpers.closeModal(ui.editModal);
                    } else {
                        ui.editModalError.textContent = "Input cannot be empty.";
                        ui.editModalError.classList.remove('hidden');
                    }
                };
                
                ui.editModalSaveBtn.addEventListener('click', helpers._editModalSaveHandler);
                helpers.openModal(ui.editModal);
            },
            applyTheme: (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    ui.sunIcon.classList.add('hidden');
                    ui.moonIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    ui.sunIcon.classList.remove('hidden');
                    ui.moonIcon.classList.add('hidden');
                }
                localStorage.theme = theme;
            },
            setSaveButtonState: (isSaving) => {
                ui.saveButtonText.textContent = isSaving ? 'Saving...' : 'Save';
                ui.saveSpinner.classList.toggle('hidden', !isSaving);
                ui.saveChecklistBtn.disabled = isSaving;
            },
            copyToClipboard: (text, button, successText = 'Copied!', originalText = 'Copy') => {
                if (!navigator.clipboard) {
                    // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        if (button) button.textContent = successText;
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                    }
                    document.body.removeChild(textArea);
                } else {
                    navigator.clipboard.writeText(text).then(() => {
                        if (button) button.textContent = successText;
                    }, (err) => {
                        console.error('Async: Could not copy text: ', err);
                    });
                }
                if (button) setTimeout(() => { button.textContent = originalText; }, 2000);
            },
            generateUniqueId: () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            simpleMarkdownToHtml: (markdown) => {
                return markdown
                    .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<li>$1</li>')
                    .replace(/^(?!<h|<li|<ul|<p>)(.*$)/gim, '<p>$1</p>') // Wrap non-tagged lines in <p>
                    .replace(/<\/li>\n<p><li>/gim, '</li><li>') // Fix paragraph between list items
                    .replace(/<p><li>/g, '<ul><li>')
                    .replace(/<\/li>(\n<p>)?(?!<li>)/g, '</li></ul>');
            }
        };

        // --- Data & Firestore Logic ---
        function listenForChecklists() {
            if (checklistUnsubscribe) checklistUnsubscribe();
            if (!isAuthReady || !userId) return;

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/checklists`));
            checklistUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const checklists = [];
                querySnapshot.forEach((doc) => {
                    checklists.push({ id: doc.id, ...doc.data() });
                });
                renderListView(checklists);
            }, (error) => {
                console.error("Error listening for checklists:", error);
                helpers.showStatus(ui.statusMessage, "Could not load checklists.", 'error');
            });
        }

        async function handleSaveChecklist(force = false) {
            clearTimeout(saveTimeout);

            const saveAction = async () => {
                if (!isAuthReady || !currentChecklistData) return;

                const orgName = ui.orgNameInput.value.trim();
                if (!orgName) {
                    ui.orgNameError.classList.remove('hidden');
                    return;
                }
                ui.orgNameError.classList.add('hidden');

                currentChecklistData.orgName = orgName;
                currentChecklistData.lastUpdated = serverTimestamp();

                helpers.setSaveButtonState(true);

                try {
                    let docRef;
                    if (currentChecklistData.id) {
                        docRef = doc(db, `artifacts/${appId}/users/${userId}/checklists`, currentChecklistData.id);
                        await updateDoc(docRef, currentChecklistData);
                    } else {
                        const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/checklists`);
                        docRef = await addDoc(collectionRef, currentChecklistData);
                        currentChecklistData.id = docRef.id;
                        // Update UI to reflect new ID (for delete/share buttons)
                        ui.deleteChecklistBtn.classList.remove('hidden');
                        ui.shareChecklistBtn.classList.remove('hidden');
                    }
                    helpers.showStatus(ui.statusMessage, "Checklist saved!", 'success');
                } catch (error) {
                    console.error("Error saving checklist: ", error);
                    helpers.showStatus(ui.statusMessage, `Error saving: ${error.message}`, 'error');
                } finally {
                    helpers.setSaveButtonState(false);
                }
            };

            if (force) {
                await saveAction();
            } else {
                saveTimeout = setTimeout(saveAction, 1500); // Increased debounce time
            }
        }

        async function handleDeleteChecklist() {
            if (!currentChecklistData?.id) return;
            helpers.openConfirmationModal(
                "Delete Checklist?",
                `Are you sure you want to permanently delete the "${currentChecklistData.orgName}" checklist? This action cannot be undone.`,
                async () => {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/checklists`, currentChecklistData.id);
                        await deleteDoc(docRef);
                        // Also delete associated attachments from storage
                        // Note: This is a simplified deletion. For large numbers of files, a Cloud Function is better.
                        helpers.showView('list');
                    } catch (error) {
                        console.error("Error deleting checklist:", error);
                        helpers.showStatus(ui.statusMessage, `Error deleting: ${error.message}`, 'error');
                    }
                }
            );
        }

        async function handleShareChecklist() {
            if (!currentChecklistData?.id) return;
            helpers.showStatus(ui.statusMessage, "Generating shareable link...", 'info', null);
            try {
                // Create/update a public, read-only version of the checklist
                const publicDocRef = doc(db, `artifacts/${appId}/public/shared_checklists`, currentChecklistData.id);
                await setDoc(publicDocRef, {
                    ...currentChecklistData,
                    originalOwner: userId,
                    isShared: true
                });
                
                ui.shareIdDisplay.textContent = currentChecklistData.id;
                helpers.openModal(ui.shareModal);
                helpers.showStatus(ui.statusMessage, "Share link ready!", 'success');
            } catch (error) {
                console.error("Error creating share link:", error);
                helpers.showStatus(ui.statusMessage, `Error sharing: ${error.message}`, 'error');
            }
        }

        async function handleImportConfirm() {
            const shareId = ui.importIdInput.value.trim();
            if (!shareId) {
                helpers.showStatus(ui.importStatusMessage, "Please enter a Share ID.", 'error');
                return;
            }
            helpers.showStatus(ui.importStatusMessage, "Importing...", 'info', null);

            try {
                const publicDocRef = doc(db, `artifacts/${appId}/public/shared_checklists`, shareId);
                const docSnap = await getDoc(publicDocRef);

                if (!docSnap.exists()) {
                    throw new Error("Shared checklist not found. Please check the ID.");
                }

                let importedData = docSnap.data();
                // Clean up data for new user
                delete importedData.originalOwner;
                delete importedData.isShared;
                importedData.orgName = `(Imported) ${importedData.orgName}`;

                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/checklists`);
                const newDocRef = await addDoc(collectionRef, importedData);
                
                helpers.showStatus(ui.importStatusMessage, "Import successful!", 'success');
                setTimeout(() => {
                    helpers.closeModal(ui.importModal);
                    renderChecklistForm(newDocRef.id);
                }, 1500);

            } catch (error) {
                console.error("Error importing checklist:", error);
                helpers.showStatus(ui.importStatusMessage, `Import failed: ${error.message}`, 'error');
            }
        }

        // --- Gemini API Feature ---
        async function handleGenerateSummary() {
            if (!currentChecklistData) return;

            ui.summaryLoader.style.display = 'block';
            ui.summaryContent.innerHTML = '';
            helpers.openModal(ui.summaryModal);

            let checklistText = `Organization: ${currentChecklistData.orgName}\n\n`;
            currentChecklistData.categories.forEach(category => {
                checklistText += `Category: ${category.name}\n`;
                category.items.forEach(item => {
                    checklistText += `- Item: "${item.text}", Status: ${item.checked ? 'Completed' : 'Incomplete'}`;
                    if(item.notes) {
                        checklistText += `, Notes: "${item.notes}"`;
                    }
                    checklistText += '\n';
                });
                checklistText += '\n';
            });
            
            const prompt = `As a compliance expert for non-profit animal rescue organizations, analyze the following checklist data for "${currentChecklistData.orgName}". Provide a brief, high-level summary of their compliance status. Then, create a clear list of "Action Items" for any incomplete items or items with notes that suggest a potential issue. Format your response in simple Markdown.

            Checklist Data:
            ${checklistText}`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // API key will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error.message}`);
                }

                const result = await response.json();
                
                let text = 'No summary could be generated. Please try again.';
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                }
                
                ui.summaryContent.innerHTML = helpers.simpleMarkdownToHtml(text);

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                ui.summaryContent.innerHTML = `<p class="text-red-500">An error occurred while generating the summary: ${error.message}</p>`;
            } finally {
                ui.summaryLoader.style.display = 'none';
            }
        }

        // --- Rendering Logic ---
        function renderListView(checklists) {
            const container = ui.savedChecklistsContainer;
            container.innerHTML = '';
            ui.noChecklistsMessage.classList.toggle('hidden', checklists.length > 0);

            const sortedChecklists = checklists.sort((a, b) => {
                const timeA = a.lastUpdated?.toDate() || 0;
                const timeB = b.lastUpdated?.toDate() || 0;
                return timeB - timeA;
            });

            sortedChecklists.forEach(list => {
                const card = document.createElement('div');
                card.className = 'p-5 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-transparent hover:border-sky-500/50';
                card.dataset.id = list.id;
                card.addEventListener('click', () => renderChecklistForm(list.id));
                
                const lastUpdated = list.lastUpdated ? list.lastUpdated.toDate().toLocaleString() : 'N/A';

                card.innerHTML = `
                    <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 truncate">${list.orgName || 'Untitled Checklist'}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Last updated: ${lastUpdated}</p>
                `;
                container.appendChild(card);
            });
            filterAndRenderListView();
        }
        
        function filterAndRenderListView() {
            const searchTerm = ui.searchInput.value.toLowerCase();
            const cards = ui.savedChecklistsContainer.querySelectorAll('[data-id]');
            let visibleCount = 0;
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const isVisible = title.includes(searchTerm);
                card.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            ui.noChecklistsMessage.classList.toggle('hidden', visibleCount > 0 && searchTerm.length === 0);
        }

        async function renderChecklistForm(checklistId = null) {
            currentChecklistData = null;
            if (checklistId) {
                try {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/checklists`, checklistId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        currentChecklistData = { id: docSnap.id, ...docSnap.data() };
                    } else {
                        throw new Error("Checklist not found!");
                    }
                } catch (error) {
                    console.error(error);
                    helpers.showStatus(ui.statusMessage, "Could not find the selected checklist.", 'error');
                    helpers.showView('list');
                    return;
                }
            } else {
                currentChecklistData = {
                    id: null,
                    orgName: '',
                    categories: JSON.parse(JSON.stringify(checklistMasterTemplate)),
                    lastUpdated: null
                };
            }

            ui.checklistItemsContainer.innerHTML = '';
            ui.orgNameInput.value = currentChecklistData.orgName || '';
            ui.orgNameInputPrintHeader.textContent = currentChecklistData.orgName || "New Checklist";
            ui.checklistTitle.textContent = currentChecklistData.orgName || 'New Checklist';
            ui.deleteChecklistBtn.classList.toggle('hidden', !checklistId);
            ui.shareChecklistBtn.classList.toggle('hidden', !checklistId);
            ui.orgNameError.classList.add('hidden');

            currentChecklistData.categories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.innerHTML = renderCategory(category);
                ui.checklistItemsContainer.appendChild(categoryEl.firstElementChild);
            });

            helpers.showView('checklist');
        }

        function renderCategory(category) {
            return `
                <div class="category-block bg-slate-50/50 dark:bg-slate-800/50 rounded-lg border border-slate-200/80 dark:border-slate-700/80 expanded" data-category-id="${category.id}">
                    <div class="flex justify-between items-center p-4 cursor-pointer" data-action="toggle-category">
                        <div class="flex items-center space-x-3">
                            <div class="category-toggle-icon text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </div>
                            <h3 class="category-title text-xl font-semibold text-slate-700 dark:text-slate-300">${category.name}</h3>
                        </div>
                        <div class="category-actions flex space-x-2">
                            ${category.isCustom ? `
                            <button class="edit-button p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700" data-action="edit-category" aria-label="Edit category name">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button class="delete-button p-1.5 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50" data-action="delete-category" aria-label="Delete category">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="category-content px-4 pb-4">
                        <div class="space-y-5 border-t border-slate-200 dark:border-slate-700 pt-4">
                            ${category.items.map(item => renderItem(item, category.id)).join('')}
                            <button class="add-item-button mt-4 w-full text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 dark:bg-slate-700/80 dark:hover:bg-slate-700 dark:text-slate-300 font-semibold py-2 px-4 rounded-md transition-colors flex items-center justify-center space-x-2" data-action="add-item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                <span>Add Checklist Item</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderItem(item, categoryId) {
            const toolButtonHtml = item.link ? `
                <button class="contextual-tool-button mt-1.5 flex items-center space-x-2 text-sm text-sky-600 dark:text-sky-400 hover:underline" data-action="open-tool-modal" data-modal-id="${item.modalId}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                    <span>${item.linkText || 'Open Tool'}</span>
                </button>
            ` : '';

            return `
                <div class="checklist-item border-b border-slate-100 dark:border-slate-700/50 pb-4 last:border-b-0" data-item-id="${item.id}" data-category-id="${categoryId}">
                    <div class="flex items-start space-x-4">
                        <input type="checkbox" id="check-${item.id}" class="custom-checkbox mt-1" data-action="check-item" ${item.checked ? 'checked' : ''}>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <label for="check-${item.id}" class="item-text flex-1 text-slate-700 dark:text-slate-300 cursor-pointer">${item.text}</label>
                                <div class="item-actions flex space-x-1 ml-2">
                                    ${item.isCustom ? `
                                    <button class="edit-button p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700" data-action="edit-item" aria-label="Edit item text">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="delete-button p-1.5 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50" data-action="delete-item" aria-label="Delete item">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                            ${toolButtonHtml}
                        </div>
                    </div>
                    <div class="pl-10 mt-2 space-y-3">
                        <textarea class="notes-input w-full p-2 text-sm border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 rounded-md focus:ring-1 focus:ring-sky-500 focus:border-sky-500 transition-shadow" data-action="update-note" placeholder="Add notes...">${item.notes || ''}</textarea>
                        <div class="attachment-section">
                            <div class="attachment-list space-y-2">
                                ${item.attachments?.map(att => renderAttachment(att)).join('') || ''}
                            </div>
                            <div class="attachment-actions mt-2">
                                <label class="file-input-wrapper text-sm text-slate-600 dark:text-slate-400 hover:text-sky-600 dark:hover:text-sky-400 cursor-pointer">
                                    + Add Attachment
                                    <input type="file" class="hidden" data-action="add-attachment">
                                </label>
                                <span class="upload-status text-xs ml-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderAttachment(attachment) {
            return `
                <div class="attachment-item flex items-center justify-between p-2 bg-slate-100 dark:bg-slate-700/70 rounded-md" data-filename="${attachment.fileName}">
                    <a href="${attachment.url}" target="_blank" rel="noopener noreferrer" class="flex-1 truncate text-sm text-indigo-600 dark:text-indigo-400 hover:underline no-print-url" title="${attachment.fileName}">${attachment.fileName}</a>
                    <button class="delete-attachment-btn p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" data-action="delete-attachment" aria-label="Delete attachment">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            `;
        }

        function renderExternalTools() {
            const tools = [
                { title: "IRS EO Select Check", description: "Verify 501(c)(3) status.", modalId: "ein-lookup-modal", icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />` },
                { title: "ProPublica Nonprofit Explorer", description: "Review Form 990 filings.", modalId: "propublica-lookup-modal", icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />` },
                { title: "USDA APHIS Search", description: "Check for animal transport licenses.", modalId: "aphis-lookup-modal", icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />` },
                { title: "NASCO State Officials", description: "Find state charity registration offices.", modalId: "nasco-reg-modal", icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />` },
                { title: "BBB Scam Tracker", description: "Look up scams and complaints.", modalId: "bbb-scam-modal", icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />` },
                { title: "Charity Navigator", description: "Ratings for larger charities.", modalId: "charitynav-lookup-modal", icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />` }
            ];

            const grid = ui.externalToolsGrid;
            grid.innerHTML = '';
            tools.forEach(tool => {
                const card = document.createElement('div');
                card.className = 'tool-card flex items-start p-4 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-transparent hover:border-sky-500/50';
                card.dataset.modalId = tool.modalId;
                card.innerHTML = `
                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-lg bg-sky-100 dark:bg-sky-900 text-sky-600 dark:text-sky-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">${tool.icon}</svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-md font-bold text-slate-800 dark:text-slate-200">${tool.title}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">${tool.description}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- Event Handlers & UI Updates ---
        
        function handleChecklistContainerClick(event) {
            const target = event.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const itemEl = target.closest('.checklist-item');
            const categoryEl = target.closest('.category-block');
            const categoryId = categoryEl?.dataset.categoryId;
            const itemId = itemEl?.dataset.itemId;

            const actions = {
                'toggle-category': () => categoryEl.classList.toggle('expanded'),
                'edit-category': () => editCategory(categoryId),
                'delete-category': () => deleteCategory(categoryId),
                'add-item': () => addItem(categoryId),
                'edit-item': () => editItem(categoryId, itemId),
                'delete-item': () => deleteItem(categoryId, itemId),
                'delete-attachment': () => {
                    const attachmentEl = target.closest('.attachment-item');
                    const fileName = attachmentEl?.dataset.filename;
                    deleteAttachment(categoryId, itemId, fileName);
                },
                'open-tool-modal': () => {
                    const modalId = target.dataset.modalId;
                    const modal = document.getElementById(modalId);
                    if (modal) helpers.openModal(modal);
                }
            };

            if (actions[action]) {
                actions[action]();
            }
        }
        
        function handleChecklistContainerInput(event) {
            const target = event.target.closest('[data-action="update-note"]');
            if (!target) return;
            
            const itemEl = target.closest('.checklist-item');
            const categoryId = itemEl?.dataset.categoryId;
            const itemId = itemEl?.dataset.itemId;

            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            const item = category?.items.find(i => i.id === itemId);
            if (item) {
                item.notes = target.value;
                handleSaveChecklist(); // Debounced save
            }
        }
        
        function handleChecklistContainerChange(event) {
            const target = event.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const itemEl = target.closest('.checklist-item');
            const categoryId = itemEl?.dataset.categoryId;
            const itemId = itemEl?.dataset.itemId;

            if (action === 'check-item') {
                const category = currentChecklistData.categories.find(c => c.id === categoryId);
                const item = category?.items.find(i => i.id === itemId);
                if (item) {
                    item.checked = target.checked;
                    handleSaveChecklist(true); // Immediate save for checkbox
                }
            } else if (action === 'add-attachment') {
                const file = target.files[0];
                if (file) {
                    const uploadStatusEl = itemEl.querySelector('.upload-status');
                    handleAttachmentUpload(file, categoryId, itemId, uploadStatusEl);
                }
            }
        }

        function addCategory() {
            helpers.openEditModal({
                title: "Add New Category",
                label: "Category Name",
                placeholder: "e.g., Volunteer Management",
                currentValue: "",
                onSave: (newCategoryName) => {
                    const newCategory = {
                        id: helpers.generateUniqueId(),
                        name: newCategoryName,
                        isCustom: true,
                        items: []
                    };
                    currentChecklistData.categories.push(newCategory);
                    rerenderChecklist();
                    handleSaveChecklist(true);
                }
            });
        }

        function editCategory(categoryId) {
            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            if (!category) return;

            helpers.openEditModal({
                title: "Edit Category",
                label: "Category Name",
                placeholder: "Enter new category name",
                currentValue: category.name,
                onSave: (updatedName) => {
                    category.name = updatedName;
                    rerenderChecklist();
                    handleSaveChecklist(true);
                }
            });
        }

        function deleteCategory(categoryId) {
            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            if (!category) return;
            
            helpers.openConfirmationModal(
                "Delete Category?",
                `Are you sure you want to delete the "${category.name}" category and all its items?`,
                () => {
                    currentChecklistData.categories = currentChecklistData.categories.filter(c => c.id !== categoryId);
                    rerenderChecklist();
                    handleSaveChecklist(true);
                }
            );
        }

        function addItem(categoryId) {
            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            if (!category) return;

            helpers.openEditModal({
                title: "Add New Item",
                label: "Item Text",
                placeholder: "e.g., Volunteer onboarding process documented?",
                currentValue: "",
                onSave: (newItemText) => {
                    const newItem = {
                        id: helpers.generateUniqueId(),
                        text: newItemText,
                        isCustom: true,
                        attachments: [],
                        notes: "",
                        checked: false
                    };
                    category.items.push(newItem);
                    rerenderChecklist();
                    handleSaveChecklist(true);
                }
            });
        }

        function editItem(categoryId, itemId) {
            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            const item = category?.items.find(i => i.id === itemId);
            if (!item) return;

            helpers.openEditModal({
                title: "Edit Item",
                label: "Item Text",
                placeholder: "Enter new item text",
                currentValue: item.text,
                onSave: (updatedText) => {
                    item.text = updatedText;
                    rerenderChecklist();
                    handleSaveChecklist(true);
                }
            });
        }

        function deleteItem(categoryId, itemId) {
            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            if (!category) return;

            helpers.openConfirmationModal(
                "Delete Item?",
                `Are you sure you want to delete this checklist item?`,
                () => {
                    category.items = category.items.filter(i => i.id !== itemId);
                    rerenderChecklist();
                    handleSaveChecklist(true);
                }
            );
        }
        
        async function handleAttachmentUpload(file, categoryId, itemId, uploadStatusElement) {
            if (!file) return;

            if (!currentChecklistData.id) {
                helpers.showStatus(uploadStatusElement, "Saving checklist first...", 'info', null);
                await handleSaveChecklist(true);
                if (!currentChecklistData.id) {
                    helpers.showStatus(uploadStatusElement, "Please enter an organization name before adding attachments.", 'error');
                    return;
                }
            }

            helpers.showStatus(uploadStatusElement, `Uploading...`, 'info', null);

            try {
                const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/attachments/${currentChecklistData.id}/${itemId}/${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                const category = currentChecklistData.categories.find(c => c.id === categoryId);
                const item = category?.items.find(i => i.id === itemId);

                if (item) {
                    if (!item.attachments) item.attachments = [];
                    item.attachments.push({ fileName: file.name, url: downloadURL, type: file.type, size: file.size });
                    
                    rerenderChecklist();
                    await handleSaveChecklist(true);
                    helpers.showStatus(uploadStatusElement, `Upload complete!`, 'success');
                }
            } catch (error) {
                console.error("Error uploading attachment:", error);
                helpers.showStatus(uploadStatusElement, `Upload failed.`, 'error');
            }
        }
        
        async function deleteAttachment(categoryId, itemId, fileName) {
            const category = currentChecklistData.categories.find(c => c.id === categoryId);
            const item = category?.items.find(i => i.id === itemId);
            if (!item || !item.attachments) return;

            helpers.openConfirmationModal(
                "Delete Attachment?",
                `Are you sure you want to delete the file "${fileName}"?`,
                async () => {
                    try {
                        // Delete from storage
                        const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/attachments/${currentChecklistData.id}/${itemId}/${fileName}`);
                        await deleteObject(storageRef);
                        
                        // Remove from data object
                        item.attachments = item.attachments.filter(att => att.fileName !== fileName);
                        
                        rerenderChecklist();
                        await handleSaveChecklist(true);
                    } catch (error) {
                        console.error("Error deleting attachment:", error);
                        // If file not found in storage, still remove from DB
                        if (error.code === 'storage/object-not-found') {
                           item.attachments = item.attachments.filter(att => att.fileName !== fileName);
                           rerenderChecklist();
                           await handleSaveChecklist(true);
                        } else {
                           helpers.showStatus(ui.statusMessage, `Error deleting file: ${error.message}`, 'error');
                        }
                    }
                }
            );
        }

        function rerenderChecklist() {
            const container = ui.checklistItemsContainer;
            const expandedStates = {};
            // Save expanded/collapsed state
            container.querySelectorAll('.category-block').forEach(el => {
                expandedStates[el.dataset.categoryId] = el.classList.contains('expanded');
            });
            
            container.innerHTML = '';
            currentChecklistData.categories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.innerHTML = renderCategory(category);
                const categoryBlock = categoryEl.firstElementChild;
                
                // Restore expanded/collapsed state
                if (expandedStates[category.id] === false) { // Check for explicit false
                    categoryBlock.classList.remove('expanded');
                } else {
                    categoryBlock.classList.add('expanded');
                }

                container.appendChild(categoryBlock);
            });
        }
        
        function handleCopyChecklistText() {
            if (!currentChecklistData) return;
            
            let text = `Checklist for: ${currentChecklistData.orgName}\n\n`;
            currentChecklistData.categories.forEach(category => {
                text += `--- ${category.name.toUpperCase()} ---\n`;
                category.items.forEach(item => {
                    text += `[${item.checked ? 'x' : ' '}] ${item.text}\n`;
                    if (item.notes) {
                        text += `    Notes: ${item.notes.replace(/\n/g, '\n           ')}\n`;
                    }
                });
                text += '\n';
            });
            
            helpers.copyToClipboard(text, ui.copyChecklistBtn, 'Copied!', 'Copy as Text');
        }

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
