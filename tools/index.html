<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Recon | Integrated OSINT & Compliance Tool</title>
    <meta name="description" content="A free, integrated open-source intelligence (OSINT) and compliance checklist tool for investigating nonprofit animal rescue organizations.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <style>
        :root {
            --background-start-rgb: 243, 244, 246; --background-end-rgb: 229, 231, 235;
            --text-color: #1f2937; --card-bg: 255, 255, 255;
            --border-color: #e5e7eb; --input-bg: #f9fafb;
             --scrollbar-track-bg: #e2e8f0; --scrollbar-thumb-bg: #94a3b8; --scrollbar-thumb-hover-bg: #64748b;
            --checkbox-bg: #fff; --checkbox-border: #cbd5e1; --checkbox-checked-border: #0ea5e9;
            --checkbox-checkmark-color: #0ea5e9; --modal-overlay-bg: rgba(15, 23, 42, 0.6);
        }
        html.dark {
            --background-start-rgb: 17, 24, 39; --background-end-rgb: 3, 7, 18;
            --text-color: #f9fafb; --card-bg: 31, 41, 55;
            --border-color: #4b5563; --input-bg: #374151;
            --scrollbar-track-bg: #334155; --scrollbar-thumb-bg: #64748b; --scrollbar-thumb-hover-bg: #94a3b8;
            --checkbox-bg: #334155; --checkbox-border: #475569; --checkbox-checked-border: #38bdf8;
            --checkbox-checkmark-color: #38bdf8;
        }
        body {
            font-family: 'Inter', sans-serif; color: var(--text-color);
            background: linear-gradient(to bottom right, rgb(var(--background-start-rgb)), rgb(var(--background-end-rgb)));
        }
        .card {
            background-color: rgba(var(--card-bg), 0.7); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border: 1px solid var(--border-color);
            @apply rounded-xl shadow-lg;
        }
        .input-group { @apply relative; }
        .input-icon { @apply absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400; }
        .form-input {
            @apply w-full border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-md py-2.5 pl-10 pr-4 transition-colors;
            background-color: var(--input-bg);
        }
        .accordion-header { @apply flex justify-between items-center w-full p-5 text-left; }
        .accordion-content { @apply max-h-0 overflow-hidden transition-all duration-500 ease-in-out; }
        .accordion-content.open { @apply max-h-screen; }
        .chevron-icon { @apply transition-transform duration-300; }
        .btn { @apply px-5 py-2.5 rounded-md font-semibold text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900; }
        .btn-secondary { @apply bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-900; }
        .result-link-card { @apply flex items-center justify-between p-4 border rounded-lg transition-all duration-200; border-color: var(--border-color); background-color: rgba(var(--card-bg), 0.5); }
        .result-link-card:hover { border-color: #4f46e5; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .visited-link { color: #8b5cf6 !important; }
        .hidden-fade { opacity: 0; transform: translateY(10px); transition: opacity 0.5s ease, transform 0.5s ease; visibility: hidden; }
        .visible-fade { opacity: 1; transform: translateY(0); visibility: visible; }
        select.form-input { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-chevron-down'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.25em; }
        html.dark select.form-input { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23d1d5db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-chevron-down'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
        #toast-container { @apply fixed bottom-5 right-5 flex flex-col items-end space-y-2 z-50; }
        .toast { @apply flex items-center space-x-3 px-4 py-3 rounded-lg shadow-lg text-white transition-all duration-300; transform: translateX(120%); opacity: 0; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { @apply bg-green-500; }
        .skeleton-loader { @apply bg-gray-200 dark:bg-gray-700 rounded-md animate-pulse; }
        .nav-tab { @apply px-4 py-2 font-semibold text-gray-500 dark:text-gray-400 rounded-t-lg border-b-2 border-transparent transition-colors; }
        .nav-tab.active { @apply text-indigo-600 dark:text-indigo-400 border-indigo-600 dark:border-indigo-400; }
        
        /* Checklist-specific styles */
        #checklist-items-container::-webkit-scrollbar { width: 8px; }
        #checklist-items-container::-webkit-scrollbar-track { background: var(--scrollbar-track-bg); border-radius: 4px; }
        #checklist-items-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 4px; }
        #checklist-items-container::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover-bg); }
        .custom-checkbox { appearance: none; background-color: var(--checkbox-bg); margin: 0; font: inherit; color: currentColor; width: 1.25em; height: 1.25em; border: 0.15em solid var(--checkbox-border); border-radius: 0.25em; transform: translateY(-0.075em); display: grid; place-content: center; cursor: pointer; transition: 120ms all ease-in-out; }
        .custom-checkbox::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em var(--checkbox-checkmark-color); clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { border-color: var(--checkbox-checked-border); }
        .custom-checkbox:checked::before { transform: scale(1); }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-overlay-bg); padding-top: 60px; backdrop-filter: blur(4px); animation: fadeIn 0.3s ease-out; }
        .modal-content { margin: 5% auto; padding: 2rem; width: 90%; max-width: 550px; border-radius: 0.75rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .category-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .category-block.expanded .category-content { max-height: 2000px; }
        .category-toggle-icon { transition: transform 0.3s ease-in-out; }
        .category-block.expanded .category-toggle-icon { transform: rotate(90deg); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="paw-print" class="w-6 h-6 text-white"></i></div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Charity Recon Tool</h1>
                </div>
            </div>
             <div id="user-info-header" class="hidden items-center space-x-4">
                 <div class="text-right text-sm">
                     <span class="font-medium" id="user-name-header"></span>
                     <span class="block text-xs text-gray-500 dark:text-gray-400" id="user-id-header"></span>
                 </div>
                <button id="sign-out-btn-header" class="btn btn-secondary !px-3 !py-1.5 flex items-center space-x-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Sign Out</span>
                 </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" aria-label="Toggle dark mode">
                    <i data-lucide="sun" class="w-6 h-6 block dark:hidden"></i>
                    <i data-lucide="moon" class="w-6 h-6 hidden dark:block"></i>
                </button>
            </div>
            <button id="theme-toggle-logged-out" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors hidden" aria-label="Toggle dark mode">
                <i data-lucide="sun" class="w-6 h-6 block dark:hidden"></i>
                <i data-lucide="moon" class="w-6 h-6 hidden dark:block"></i>
            </button>
        </header>

        <nav class="border-b border-gray-200 dark:border-gray-700 mb-8 hidden">
            <div class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-osint" class="nav-tab active" data-view="osint-view" role="tab">
                    <span class="flex items-center"><i data-lucide="search" class="w-5 h-5 mr-2"></i>OSINT Tool</span>
                </button>
                <button id="tab-checklist" class="nav-tab" data-view="checklist-view" role="tab">
                     <span class="flex items-center"><i data-lucide="check-square" class="w-5 h-5 mr-2"></i>Compliance Checklists</span>
                </button>
            </div>
        </nav>
        
        <main>
            <section id="login-view" class="view-content hidden">
                <div class="max-w-md mx-auto card p-8 mt-10">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="bg-indigo-600 p-2 rounded-lg">
                            <i data-lucide="paw-print" class="w-6 h-6 text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Charity Recon Login</h2>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">Sign in to save and sync your compliance checklists.</p>
                    
                    <form id="email-login-form" class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="mail" class="input-icon"></i>
                            <input type="email" id="login-email" class="form-input" placeholder="Email" required>
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="input-icon"></i>
                            <input type="password" id="login-password" class="form-input" placeholder="Password" required>
                        </div>
                        
                        <p id="login-error-message" class="text-red-500 text-sm text-center hidden"></p>

                        <div class="flex flex-col sm:flex-row gap-3">
                            <button type="submit" id="email-login-btn" class="btn btn-primary w-full justify-center">Sign In</button>
                            <button type="button" id="email-signup-btn" class="btn btn-secondary w-full justify-center">Sign Up</button>
                        </div>
                    </form>

                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-center">
                            <span class="bg-white dark:bg-gray-800 px-2 text-sm text-gray-500 dark:text-gray-400">Or</span>
                        </div>
                    </div>

                    <button id="google-signin-btn" class="btn bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 w-full flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        <span>Sign in with Google</span>
                    </button>
                </div>
            </section>

            <section id="osint-view" class="view-content hidden">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">OSINT Dashboard</h2>
                    <p class="mt-2 max-w-2xl mx-auto text-gray-600 dark:text-gray-300">Enter an organization's details to generate a dashboard of direct links for your investigation.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <aside class="lg:col-span-1">
                        <div class="card p-6 sticky top-8">
                            <h2 class="text-xl font-semibold mb-4">Investigation Details</h2>
                            <form id="search-form" class="space-y-4" aria-labelledby="form-heading">
                                <div class="input-group">
                                    <i data-lucide="building" class="input-icon"></i>
                                    <input type="text" id="org-name" class="form-input" aria-label="Organization Name" placeholder="Organization Name" required>
                                </div>
                                <div class="input-group">
                                     <i data-lucide="user" class="input-icon"></i>
                                    <input type="text" id="person-name" class="form-input" aria-label="Key Person (Optional)" placeholder="Key Person (Optional)">
                                </div>
                                 <div class="input-group">
                                    <i data-lucide="hash" class="input-icon"></i>
                                    <input type="text" id="org-ein" class="form-input" aria-label="EIN (Optional)" placeholder="EIN (e.g., 12-3456789)">
                                </div>
                                <div class="input-group">
                                     <i data-lucide="map" class="input-icon"></i>
                                    <input type="text" id="location" class="form-input" aria-label="City or Location (Optional)" placeholder="City / Location (Optional)">
                                </div>
                                <div class="input-group">
                                    <i data-lucide="globe" class="input-icon"></i>
                                     <input type="text" id="domain-name" class="form-input" aria-label="Domain Name (Optional)" placeholder="Domain Name (e.g., happypaws.org)">
                                </div>
                                <div class="input-group">
                                    <i data-lucide="at-sign" class="input-icon"></i>
                                    <input type="text" id="social-handle" class="form-input" aria-label="Social Media Handle (Optional)" placeholder="Social Media Handle (e.g., happypaws)">
                                </div>
                                <div class="input-group">
                                    <i data-lucide="map-pin" class="input-icon"></i>
                                    <select id="state-select" class="form-input" aria-label="State (Optional)">
                                        <option value="">Select a State (Optional)</option>
                                    </select>
                                </div>
                                <div class="flex space-x-2">
                                     <button type="submit" id="generate-button" class="btn btn-primary flex items-center justify-center space-x-2 w-full">
                                        <i data-lucide="search" class="w-5 h-5"></i><span>Generate</span>
                                    </button>
                                    <button type="button" id="clear-button" class="btn btn-secondary flex items-center justify-center space-x-2 w-auto px-4" title="Clear Form & Results" aria-label="Clear form and results">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </form>
                            <p id="error-message" class="text-red-500 mt-3 text-center text-sm font-medium hidden"></p>
                        </div>
                    </aside>
                    <section class="lg:col-span-2" aria-live="polite">
                        <div id="results-container" class="space-y-1 hidden-fade">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                                <h3 class="text-2xl font-bold" id="results-title"></h3>
                                <button id="start-checklist-from-osint-btn" class="btn btn-primary mt-4 sm:mt-0 flex items-center justify-center space-x-2">
                                    <i data-lucide="file-plus-2" class="w-5 h-5"></i>
                                    <span>Start Compliance Checklist</span>
                                </button>
                            </div>
                            <div id="accordion-container" class="space-y-2"></div>
                        </div>
                         <div id="placeholder" class="text-center py-20 card">
                            <i data-lucide="file-search" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-500"></i>
                            <h3 class="mt-4 text-lg font-semibold text-gray-600 dark:text-gray-400">Your investigation results will appear here.</h3>
                            <p class="mt-1 text-sm text-gray-500">Fill out the form to get started.</p>
                        </div>
                        <div id="skeleton-container" class="space-y-4 hidden">
                            <div class="skeleton-loader h-12 w-full"></div>
                            <div class="skeleton-loader h-24 w-full"></div>
                            <div class="skeleton-loader h-24 w-full"></div>
                        </div>
                    </section>
                </div>
            </section>

            <section id="checklist-view" class="view-content hidden">
                 <div id="checklist-loading-view" class="text-center py-20 card">
                     <i data-lucide="loader-2" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-500 animate-spin"></i>
                     <p class="mt-4 text-lg font-semibold text-gray-600 dark:text-gray-400">Connecting to checklist service...</p>
                     <p id="checklist-auth-error" class="mt-2 text-red-500 dark:text-red-400 text-sm"></p>
                </div>
                <div id="checklist-main-content" class="hidden">
                    <div id="checklist-list-view">
                        <header class="mb-8 text-center">
                            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Compliance Checklists</h1>
                            <p class="text-gray-500 dark:text-gray-400 mt-2 text-lg">Your cloud-synced checklists for ensuring animal welfare standards.</p>
                        </header>
                         <div class="mb-6 flex justify-center">
                            <button id="new-checklist-btn" class="btn btn-primary flex items-center justify-center space-x-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Start New Checklist</span>
                            </button>
                        </div>
                        <div id="search-container" class="mb-8 relative max-w-2xl mx-auto">
                            <input type="text" id="checklist-search-input" placeholder="Search checklists..." class="w-full p-4 pl-12 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow dark:placeholder-gray-400">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                 <i data-lucide="search" class="h-6 w-6 text-gray-400 dark:text-gray-500"></i>
                            </div>
                        </div>
                        <div id="no-checklists-message" class="text-center py-16 card hidden">
                             <i data-lucide="file-x" class="w-20 h-20 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
                            <p class="text-2xl font-semibold text-gray-700 dark:text-gray-300">No checklists found.</p>
                            <p class="text-gray-500 dark:text-gray-400">Click "Start New" to begin. Checklists shared with you will also appear here.</p>
                        </div>
                        <div id="saved-checklists-container" class="space-y-4 max-w-4xl mx-auto"></div>
                    </div>

                    <div id="checklist-editor-view" class="hidden card p-6 sm:p-8">
                        <header class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                             <button id="back-to-list-btn" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-semibold flex items-center space-x-1.5 group mb-2">
                                <i data-lucide="arrow-left" class="w-5 h-5 transition-transform group-hover:-translate-x-1"></i>
                                <span>Back to List</span>
                            </button>
                            <h2 id="checklist-title" class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">New Checklist</h2>
                             <div class="mt-6">
                                <label for="checklist-org-name-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Rescue Organization Name</label>
                                <input type="text" id="checklist-org-name-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-900 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow dark:placeholder-gray-400" placeholder="e.g., Happy Paws Rescue">
                                <p id="checklist-org-name-error" class="text-red-500 dark:text-red-400 text-sm mt-1 hidden">Organization name cannot be empty.</p>
                            </div>
                        </header>
                        <div id="checklist-items-container" class="space-y-6"></div>
                        <button id="add-category-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200 font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                            <span>Add New Category</span>
                        </button>
                        <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                             <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-3">Checklist Summary</h3>
                            <textarea id="checklist-summary-notes" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 rounded-md focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" rows="6" placeholder="Add your final thoughts or overall assessment here..."></textarea>
                        </div>
                         <div class="action-buttons-container mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center gap-4">
                            <button id="delete-checklist-btn" class="hidden w-full sm:w-auto text-red-600 dark:text-red-500 hover:text-white hover:bg-red-600 dark:hover:bg-red-500 font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 border border-red-500 dark:border-red-500 hover:border-red-600 dark:hover:border-red-500">
                                <i data-lucide="trash-2" class="w-5 h-5"></i><span>Delete</span>
                            </button>
                             <div class="flex flex-col sm:flex-row sm:justify-end gap-3 flex-wrap">
                                <button id="share-checklist-btn" class="hidden w-full sm:w-auto bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-5 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                     <i data-lucide="users" class="w-5 h-5"></i><span>Share</span>
                                 </button>
                                 <button id="save-checklist-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center justify-center space-x-2 disabled:opacity-50">
                                    <span id="save-button-text">Save</span>
                                    <i id="save-spinner" data-lucide="loader-2" class="h-5 w-5 hidden spinner"></i>
                                </button>
                            </div>
                        </div>
                        <div id="status-message" class="mt-4 text-center font-medium"></div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="text-center mt-24 pt-8 border-t dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400">
            <p><strong>Disclaimer:</strong> This tool aggregates links to public information. Always verify data from multiple sources.</p>
            <p class="mt-2">Created as an open-source project. View on <a href="https://github.com/EliteGreyIT67/Charity_Recon" class="text-indigo-500 hover:underline">GitHub</a>.</p>
        </footer>
    </div>
    
    <div id="confirmation-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow-lg text-center">
             <i data-lucide="alert-triangle" class="h-12 w-12 mx-auto mb-4 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-400 p-2 rounded-full"></i>
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Are you sure?</h3>
            <p id="modal-message" class="mb-8 text-gray-500 dark:text-gray-400">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button data-dismiss="modal" class="flex-1 btn btn-secondary">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    <div id="manage-share-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow-lg">
             <i data-lucide="users" class="h-12 w-12 mx-auto mb-4 bg-purple-100 dark:bg-purple-900/40 text-purple-600 dark:text-purple-400 p-2 rounded-full"></i>
            <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2 text-center">Manage Access</h3>
            <form id="add-member-form" class="mt-6 mb-6 space-y-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Invite new member by their User ID:</p>
                <div class="flex flex-col sm:flex-row sm:space-x-2 gap-3 sm:gap-0">
                    <input type="text" id="add-member-id" class="flex-1 w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-900 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="User ID" required>
                    <select id="add-member-role" class="w-full sm:w-auto p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-900 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="editor">Editor</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <button type="submit" id="add-member-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Add Member</button>
                <p id="share-status-message" class="text-center text-sm font-medium"></p>
            </form>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Current Members</h4>
                <div id="share-members-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
            <button data-dismiss="modal" class="w-full mt-8 btn btn-secondary">Close</button>
        </div>
    </div>
    <div id="edit-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow-lg">
            <h3 id="edit-modal-title" class="text-xl font-semibold text-gray-800 dark:text-white mb-4 text-center">Edit</h3>
            <input type="text" id="edit-modal-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-900 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="">
            <p id="edit-modal-error" class="text-red-500 dark:text-red-400 text-sm mt-1 hidden"></p>
            <div class="flex justify-center space-x-4 mt-6">
                <button data-dismiss="modal" class="flex-1 btn btn-secondary">Cancel</button>
                <button id="edit-modal-save-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Save</button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script id="state-data" type="application/json">
    {
      "states": { "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas", "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "DC": "District of Columbia", "FL": "Florida", "GA": "Georgia", "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa", "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland", "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri", "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey", "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island", "SC": "South Carolina", "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont", "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming" },
      "stateResources": {
        "AL": [{ "n": "AG Charity Search", "u": "https://ago.alabama.gov/ConsumerLicense" }, { "n": "SOS Business Search", "u": "https://www.sos.alabama.gov/business-entities/search" }], "AK": [{ "n": "Dept. of Law Charity Search", "u": "https://www.law.alaska.gov/department/civil/consumer/charityreg_search.html" }, { "n": "Dept. of Commerce Business Search", "u": "https://www.commerce.alaska.gov/cbp/main/search/entities" }], "AZ": [{ "n": "SOS Charity Search", "u": "https://apps.azsos.gov/apps/tntp/se.html" }, { "n": "Corporation Commission Business Search", "u": "https://ecorp.azcc.gov/EntitySearch/Index" }], "AR": [{ "n": "SOS Charity Search", "u": "https://www.sos.arkansas.gov/business-commercial-services-bcs/charitable-entities/charity-search/" }, { "n": "SOS Business Search", "u": "https://www.sos.arkansas.gov/corps/search_all.php" }], "CA": [{ "n": "DOJ Charity Search", "u": "https://rct.doj.ca.gov/Verification/Web/Search.aspx?facility=Y" }, { "n": "SOS Business Search", "u": "https://bizfileonline.sos.ca.gov/search/business" }], "CO": [{ "n": "SOS Charity Search", "u": "https://www.sos.state.co.us/ccis/home.do" }, { "n": "SOS Business Search", "u": "https://www.sos.state.co.us/biz/BusinessEntityCriteria.do" }], "CT": [{ "n": "DCP License Lookup", "u": "https://www.elicense.ct.gov/Lookup/LicenseLookup.aspx" }, { "n": "SOS Business Search", "u": "https://service.ct.gov/business/s/onlinebusinesssearch" }], "DE": [{ "n": "Division of Corporations Search", "u": "https://icis.corp.delaware.gov/Ecorp/EntitySearch/NameSearch.aspx" }], "FL": [{ "n": "DACS Charity Search", "u": "https://csapp.fdacs.gov/cspublicapp/giftgiversquery/giftgiversquery.aspx" }, { "n": "SunBiz Business Search", "u": "http://dos.myflorida.com/sunbiz/search/" }], "GA": [{ "n": "SOS Charity Search", "u": "https://sos.ga.gov/charities-search" }, { "n": "SOS Business Search", "u": "https://ecorp.sos.ga.gov/BusinessSearch" }], "HI": [{ "n": "AG Charity Search", "u": "https://charities.ehawaii.gov/charity/search.html" }, { "n": "DCCA Business Search", "u": "https://hbe.ehawaii.gov/documents/search.html" }], "ID": [{ "n": "SOS Business Search", "u": "https://sosbiz.idaho.gov/search/business" }], "IL": [{ "n": "AG Charity Search", "u": "https://www.illinoisattorneygeneral.gov/charities/search/index.jsp" }, { "n": "SOS Business Search", "u": "https://apps.ilsos.gov/corporatellc/" }], "IN": [{ "n": "INBiz Business Search", "u": "https://inbiz.in.gov/BOS/Home/Search" }], "IA": [{ "n": "SOS Business Search", "u": "https://sos.iowa.gov/search/business/search.aspx" }], "KS": [{ "n": "SOS Charity Search", "u": "https://www.kssos.org/charities/search_charities.aspx" }, { "n": "SOS Business Search", "u": "https://www.kansas.gov/bess/flow/main?execution=e1s1" }], "KY": [{ "n": "AG Charity Search", "u": "https://ag.ky.gov/Priorities/Protecting-Kentuckians/charity/Pages/search.aspx" }, { "n": "SOS Business Search", "u": "https://web.sos.ky.gov/ftsearch/" }], "LA": [{ "n": "SOS Charity/Business Search", "u": "https://coraweb.sos.la.gov/CommercialSearch/CommercialSearch.aspx" }], "ME": [{ "n": "Dept. of Professional & Financial Regulation Search", "u": "https://www.pfr.maine.gov/almsonline/almsquery/welcome.aspx?board=4280" }, { "n": "SOS Business Search", "u": "https://apps1.web.maine.gov/cgi-bin/online/corporations/name_search.pl" }], "MD": [{ "n": "SOS Charity Search", "u": "https://sos.maryland.gov/charity/Pages/SearchCharity.aspx" }, { "n": "Dept. of Assessments and Taxation Business Search", "u": "https://egov.maryland.gov/businessexpress/entitysearch" }], "MA": [{ "n": "AG Charity Search", "u": "https://www.mass.gov/info-details/search-public-charities-filings" }, { "n": "SOS Business Search", "u": "https://corp.sec.state.ma.us/corpweb/corpsearch/corpsearch.aspx" }], "MI": [{ "n": "AG Charity Search", "u": "https://www.ag.state.mi.us/charitabletrust/frmDisclaimer.aspx" }, { "n": "LARA Business Search", "u": "https://cofs.lara.state.mi.us/SearchApi/Search/Search" }], "MN": [{ "n": "AG Charity Search", "u": "https://www.ag.state.mn.us/Charity/Search/" }, { "n": "SOS Business Search", "u": "https://mblsportal.sos.state.mn.us/Business/Search" }], "MS": [{ "n": "SOS Charity Search", "u": "https://charities.sos.ms.gov/online/portal/ch/page/charities-search/Portal.aspx" }, { "n": "SOS Business Search", "u": "https://corp.sos.ms.gov/corp/portal/c/page/corpbusinessidsearch/portal.aspx" }], "MO": [{ "n": "AG Charity Search", "u": "https://ago.mo.gov/civil-division/check-a-charity/search-charities" }, { "n": "SOS Business Search", "u": "https://bsd.sos.mo.gov/BusinessEntity/BESearch.aspx?SearchType=0" }], "MT": [{ "n": "SOS Business Search", "u": "https://biz.sosmt.gov/search/business" }], "NE": [{ "n": "SOS Business Search", "u": "https://www.nebraska.gov/sos/corp/corpsearch.cgi" }], "NV": [{ "n": "SOS Charity/Business Search", "u": "https://www.nvsos.gov/sos/businesses/search" }], "NH": [{ "n": "AG Registered Charities", "u": "https://www.doj.nh.gov/charitable-trusts/registered-charities.htm" }, { "n": "SOS Business Search", "u": "https://quickstart.sos.nh.gov/online/BusinessInquire" }], "NJ": [{ "n": "Division of Consumer Affairs Charity Search", "u": "https://charportal.dca.njoag.gov/Charity-Registration/CHR-Public-Search-Page/" }, { "n": "Dept. of Treasury Business Search", "u": "https://www.njportal.com/dor/businessnamesearch/" }], "NM": [{ "n": "AG Charity Search", "u": "https://www.nmag.gov/charities.aspx" }, { "n": "SOS Business Search", "u": "https://portal.sos.state.nm.us/BFS/online/CorporationBusinessSearch" }], "NY": [{ "n": "AG Charity Search", "u": "https://www.charitiesnys.com/RegistrySearch/search_charities.jsp" }, { "n": "Dept. of State Business Search", "u": "https://apps.dos.ny.gov/publicInquiry/" }], "NC": [{ "n": "SOS Charity Search", "u": "https://www.sosnc.gov/search/index/char" }, { "n": "SOS Business Search", "u": "https://www.sosnc.gov/search/index/corp" }], "ND": [{ "n": "SOS Charity/Business Search", "u": "https://firststop.sos.nd.gov/search/business" }], "OH": [{ "n": "AG Charity Search", "u": "https://charitableregistration.ohioattorneygeneral.gov/Charities/s/" }, { "n": "SOS Business Search", "u": "https://businesssearch.ohiosos.gov/" }], "OK": [{ "n": "SOS Charity/Business Search", "u": "https://www.sos.ok.gov/business/search.aspx" }], "OR": [{ "n": "DOJ Charity Search", "u": "https://www.doj.state.or.us/charitable-activities/charities-search/" }, { "n": "SOS Business Search", "u": "https://egov.sos.state.or.us/br/pkg_web_name_srch_inq.login" }], "PA": [{ "n": "Dept. of State Charity Search", "u": "https://www.charities.dos.pa.gov/SearchforCharities.aspx" }, { "n": "Dept. of State Business Search", "u": "https://www.corporations.pa.gov/search/bussearch" }], "RI": [{ "n": "Dept. of Business Regulation Search", "u": "https://dbr.ri.gov/public-records-search" }, { "n": "SOS Business Search", "u": "https://business.sos.ri.gov/CorpWeb/CorpSearch/CorpSearch.aspx" }], "SC": [{ "n": "SOS Charity Search", "u": "https://search.scsos.com/charities" }, { "n": "SOS Business Search", "u": "https://businessfilings.sc.gov/BusinessFiling/Entity/Search" }], "SD": [{ "n": "SOS Business Search", "u": "https://sos.sd.gov/business-services/business-search.aspx" }], "TN": [{ "n": "SOS Charity Search", "u": "https://sos.tn.gov/charitable/search" }, { "n": "SOS Business Search", "u": "https://tnbear.tn.gov/Edison/Public/BusinessNameSearch" }], "TX": [{ "n": "SOS Business Search", "u": "https://direct.sos.state.tx.us/corp/lagmenu.asp" }], "UT": [{ "n": "Division of Consumer Protection Charity Search", "u": "https://dcp.utah.gov/charities-public-search/" }, { "n": "Dept. of Commerce Business Search", "u": "https://secure.utah.gov/bes/" }], "VT": [{ "n": "SOS Business Search", "u": "https://bizfilings.vermont.gov/online/BusinessInquire/" }], "VA": [{ "n": "DACS Charity Search", "u": "https://cos.vdacs.virginia.gov/cgi-bin/char_search.cgi" }, { "n": "State Corporation Commission Business Search", "u": "httpss://cis.scc.virginia.gov/" }], "WA": [{ "n": "SOS Charity Search", "u": "https://www.sos.wa.gov/charities/search-for-a-charity" }, { "n": "SOS Business Search", "u": "https://www.sos.wa.gov/corporations-charities/search-details-and-documents" }], "WV": [{ "n": "SOS Charity/Business Search", "u": "https://apps.wv.gov/SOS/BusinessEntitySearch/" }], "WI": [{ "n": "DFI Charity Search", "u": "https://wdfi.org/apps/CharitySearch/Search.aspx" }, { "n": "DFI Business Search", "u": "https://www.wdfi.org/apps/CorpSearch/Search.aspx" }], "WY": [{ "n": "SOS Business Search", "u": "https://wyobiz.wyo.gov/Business/FilingSearch.aspx" }]
      },
      "stateAnimalWelfareResources": {}
    }
    </script>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Import necessary auth methods
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously, // Keep for fallback if needed later, but not used for login screen
            signInWithCustomToken, 
            signOut,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, where, deleteField, arrayUnion, arrayRemove, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        
        // --- App State & Config ---
        const App = {
            elements: {},
            data: {},
            firebase: { 
                db: null,
                auth: null,
                appId: 'default-app-id' // Default value
            },
            state: {
                currentView: 'osint-view',
                userId: null,
                currentChecklistData: null,
                listUnsubscribe: null,
                currentChecklistUnsubscribe: null,
                confirmAction: null,
                saveTimeout: null,
                isAuthReady: false,
                allUsersCache: {},
            },

            // --- INITIALIZATION ---
            init() {
                setLogLevel('debug'); // Enable Firestore debug logging
                console.log("App initializing...");
                this.cacheDOMElements();
                this.bindMethods(); 
                this.setupEventListeners();
                this.initTheme();
                this.initializeFirebase(); 
                this.loadStateData();
                lucide.createIcons();
                // Don't switch view here, wait for auth state
            },

             bindMethods() {
                const methodsToBind = [
                    'loadStateData', 'populateStates', 'toggleTheme', 'switchView', 
                    'handleOsintSubmit', 'clearOsintResults', 'handleAccordionClick', 
                    'startChecklistFromOsint', 'handleSignOut', 'renderChecklistForm', 
                    'showChecklistSubView', 'listenForChecklists', 'handleSaveChecklist', 
                    'handleDeleteChecklist', 'handleManageSharing', 'handleAddMember', 
                    'handleRemoveMember', 'filterAndRenderListView', 'updateDynamicToolLinks', 
                    'addCategory', 'handleChecklistContainerClick', 'handleChecklistContainerInput', 
                    'handleChecklistContainerChange', 'closeModal', 'showStatus', 'renderListView', 
                    'setupAuthListener', 'handleAutoSignIn', 'setSaveButtonState', 'buildChecklistUI',
                    'updateChecklistPermissions', 'renderCategoryHTML', 'renderItemHTML',
                    'openConfirmationModal', 'populateMembersList', 'openModal', 'initializeFirebase',
                    'handleEmailLogin', 'handleEmailSignUp', 'handleGoogleSignIn' // Add new handlers
                ];
                 methodsToBind.forEach(method => {
                    if (typeof this[method] === 'function') {
                        this[method] = this[method].bind(this);
                    } else {
                        console.warn(`Method ${method} not found for binding.`);
                    }
                });
            },
            
            initializeFirebase() {
                 try {
                    // --- Firebase configuration hardcoded as provided by user ---
                    const firebaseConfig = {
                      apiKey: "AIzaSyCSLAD2acFHCmf8bkJwQx_puLcb-HARyJE",
                      authDomain: "rescue-compliance-app.firebaseapp.com",
                      databaseURL: "https://rescue-compliance-app-default-rtdb.firebaseio.com",
                      projectId: "rescue-compliance-app",
                      storageBucket: "rescue-compliance-app.firebasestorage.app",
                      messagingSenderId: "354094080932",
                      appId: "1:354094080932:web:7c9aeb9b0036e6542d5731",
                      measurementId: "G-CL6TNFWL0L"
                    };

                    // --- Use the appId from the config and sanitize it, matching original logic ---
                    const appId = (firebaseConfig.appId && typeof firebaseConfig.appId === 'string') 
                                ? firebaseConfig.appId.replace(/[^a-zA-Z0-9_-]/g, '_') 
                                : 'default-app-id';

                    if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                        throw new Error("Firebase configuration is missing or invalid.");
                    }
                    console.log("[Firebase] Initializing Firebase with config:", firebaseConfig); 
                    const app = initializeApp(firebaseConfig);
                    this.firebase.db = getFirestore(app);
                    this.firebase.auth = getAuth(app);
                     this.firebase.appId = appId; // Use the sanitized appId
                    console.log("[Firebase] Firebase initialized successfully. Using App ID for paths:", this.firebase.appId);
                    this.setupAuthListener();
                } catch (error) {
                    console.error("[Firebase] Initialization Failed:", error);
                     if (this.elements.checklistAuthError) { 
                         this.elements.checklistAuthError.textContent = `Error: Could not connect backend. ${error.message}`;
                     }
                     if (this.elements.loginErrorMessage) { // Show error on login screen too
                         this.elements.loginErrorMessage.textContent = `Initialization Error: ${error.message}`;
                         this.elements.loginErrorMessage.classList.remove('hidden');
                     }
                     // Show login screen with error, hide main content
                     document.querySelectorAll('nav, .view-content, footer').forEach(el => el.classList.add('hidden'));
                     if (this.elements.loginView) this.elements.loginView.classList.remove('hidden');
                     if (this.elements.themeToggleLoggedOut) this.elements.themeToggleLoggedOut.classList.remove('hidden'); // Show basic theme toggle
                     if (this.elements.userInfoHeader) this.elements.userInfoHeader.classList.add('hidden'); // Hide user info header
                }
            },

            // --- MODIFIED AUTH LISTENER ---
            setupAuthListener() {
                console.log("[Auth] Setting up auth listener...");
                 if (!this.firebase.auth) {
                    console.error("[Auth] Firebase auth is not initialized. Cannot set up listener.");
                    return;
                 }
                onAuthStateChanged(this.firebase.auth, async (user) => {
                     console.log("[Auth] State changed. User:", user ? user.uid : 'null');
                    
                    if (user) {
                        // USER IS SIGNED IN
                        this.state.userId = user.uid;
                        const displayName = user.isAnonymous ? 'Anonymous User' : (user.displayName || user.email || 'Authenticated User');
                        const displayId = user.uid;

                        // Update header user info
                        if (this.elements.userNameHeader) this.elements.userNameHeader.textContent = displayName;
                        if (this.elements.userIdHeader) this.elements.userIdHeader.textContent = `ID: ${displayId}`;
                        if (this.elements.userInfoHeader) this.elements.userInfoHeader.classList.remove('hidden');
                        if (this.elements.themeToggleLoggedOut) this.elements.themeToggleLoggedOut.classList.add('hidden'); // Hide basic theme toggle


                        // Hide login screen
                        if (this.elements.loginView) this.elements.loginView.classList.add('hidden');
                        
                        // Show main app content (tabs, current view, footer)
                        document.querySelectorAll('nav, footer').forEach(el => el.classList.remove('hidden'));
                        const currentViewElement = document.getElementById(this.state.currentView || 'osint-view');
                        if (currentViewElement) currentViewElement.classList.remove('hidden');


                        // --- Original logic below ---
                        const userDocPath = `artifacts/${this.firebase.appId}/users/${user.uid}`;
                        const userRef = doc(this.firebase.db, userDocPath);
                        try {
                           // Attempt to write user doc - might be needed for first login
                           await setDoc(userRef, { 
                               lastSeen: serverTimestamp(),
                               displayName: displayName // Store display name for sharing lookup
                           }, { merge: true });
                           console.log(`[Firestore] User doc updated/created for ${user.uid}`);
                        } catch (error) {
                           console.warn("[Firestore] Could not update user doc:", error.message);
                        }

                        if (!this.state.isAuthReady) {
                            this.state.isAuthReady = true;
                            if(this.elements.checklistLoadingView) this.elements.checklistLoadingView.classList.add('hidden');
                            if(this.elements.checklistMainContent) this.elements.checklistMainContent.classList.remove('hidden');
                            this.showChecklistSubView('list'); // Default to list view on login
                            this.listenForChecklists();
                        } else {
                            // If auth state changes while already logged in (e.g., token refresh), re-listen
                            this.listenForChecklists();
                        }
                    } else {
                        // --- NO USER IS SIGNED IN ---
                        this.state.isAuthReady = false;
                        this.state.userId = null;
                        if (this.state.listUnsubscribe) {
                            this.state.listUnsubscribe();
                            this.state.listUnsubscribe = null;
                        }
                        if (this.state.currentChecklistUnsubscribe) {
                            this.state.currentChecklistUnsubscribe();
                            this.state.currentChecklistUnsubscribe = null;
                        }

                        // Hide main app content and user info header
                        document.querySelectorAll('nav, .view-content, footer').forEach(el => {
                            if (el.id !== 'login-view') el.classList.add('hidden');
                        });
                        if (this.elements.userInfoHeader) this.elements.userInfoHeader.classList.add('hidden');
                        if (this.elements.themeToggleLoggedOut) this.elements.themeToggleLoggedOut.classList.remove('hidden'); // Show basic theme toggle


                        // Show the login screen
                        if (this.elements.loginView) this.elements.loginView.classList.remove('hidden');
                        if (this.elements.loginErrorMessage) this.elements.loginErrorMessage.classList.add('hidden'); // Clear previous errors
                        
                        // Ensure checklist specific views are hidden
                        if(this.elements.checklistLoadingView) this.elements.checklistLoadingView.classList.add('hidden');
                        if(this.elements.checklistMainContent) this.elements.checklistMainContent.classList.add('hidden');
                        
                        // Attempt auto sign-in only if a token might be available
                        this.handleAutoSignIn(); 
                    }
                });
            },

            // --- MODIFIED AUTO SIGN IN ---
            async handleAutoSignIn() {
                 console.log("[Auth] Attempting auto sign-in...");
                 if (!this.firebase.auth) {
                     console.error("[Auth] Cannot auto sign-in, auth not initialized.");
                     return;
                 }
                try {
                    const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialToken) {
                         console.log("[Auth] Using custom token for sign-in.");
                        await signInWithCustomToken(this.firebase.auth, initialToken);
                         // onAuthStateChanged will handle UI updates
                    } else {
                         console.log("[Auth] No custom token found. Waiting for user interaction on login screen.");
                        // *** No automatic sign-in here - user needs to interact with the login form ***
                    }
                } catch (error) {
                    console.error("[Auth] Custom token sign-in failed:", error);
                     if(this.elements.loginErrorMessage) { // Show error on login screen
                         this.elements.loginErrorMessage.textContent = `Auto Sign-in Error: ${error.message}`;
                         this.elements.loginErrorMessage.classList.remove('hidden');
                     }
                }
            },

            loadStateData() {
                try {
                    const dataEl = document.getElementById('state-data');
                    if (!dataEl) throw new Error("State data script tag not found.");
                    const data = JSON.parse(dataEl.textContent);
                    this.data.states = data.states;
                    this.data.stateResources = data.stateResources;
                    this.data.stateAnimalWelfareResources = data.stateAnimalWelfareResources;
                    this.populateStates();
                     console.log("[Data] State data loaded successfully.");
                } catch (error) {
                    console.error("[Data] Error loading state data:", error);
                     if(this.elements.errorMessage) {
                         this.elements.errorMessage.textContent = 'Error: Could not load state resources.';
                         this.elements.errorMessage.classList.remove('hidden');
                     }
                }
            },

            // --- UI & EVENT HANDLING ---

            cacheDOMElements() {
                 console.log("[UI] Caching DOM elements...");
                const ids = [
                    'theme-toggle', 'search-form', 'generate-button', 'clear-button', 'org-name', 'person-name',
                    'org-ein', 'location', 'domain-name', 'social-handle', 'state-select', 'results-container',
                    'placeholder', 'error-message', 'results-title', 'accordion-container', 'toast-container',
                    'skeleton-container', 'tab-osint', 'tab-checklist', 'osint-view', 'checklist-view',
                    'checklist-loading-view', 'checklist-main-content', 'checklist-auth-error', 
                    // User info moved to header
                    'user-info-header', 'user-name-header', 'user-id-header', 'sign-out-btn-header', 'theme-toggle-logged-out',
                    // Original user info (now unused, but keep refs just in case)
                    'user-info', 'user-name', 'user-id', 'sign-out-btn',
                    'checklist-list-view', 'new-checklist-btn',
                    'checklist-search-input', 'no-checklists-message', 'saved-checklists-container',
                    'checklist-editor-view', 'back-to-list-btn', 'checklist-title', 'checklist-org-name-input',
                    'checklist-org-name-error', 'checklist-items-container', 'add-category-btn',
                    'checklist-summary-notes', 'delete-checklist-btn', 'share-checklist-btn', 'save-checklist-btn',
                    'save-button-text', 'save-spinner', 'status-message', 'confirmation-modal', 'modal-title',
                    'modal-message', 'modal-confirm-btn', 'manage-share-modal', 'add-member-form', 'add-member-id',
                    'add-member-role', 'add-member-btn', 'share-status-message', 'share-members-list',
                    'edit-modal', 'edit-modal-title', 'edit-modal-input', 'edit-modal-error', 'edit-modal-save-btn',
                    'start-checklist-from-osint-btn',
                    // Add new login elements
                    'login-view', 'email-login-form', 'login-email', 'login-password', 
                    'login-error-message', 'email-login-btn', 'email-signup-btn', 'google-signin-btn'
                ];
                ids.forEach(id => { 
                    const element = document.getElementById(id);
                    this.elements[id.replace(/-(\w)/g, (_, c) => c.toUpperCase())] = element; 
                });
                 console.log("[UI] DOM elements cached.");
            },

            setupEventListeners() {
                 console.log("[UI] Setting up event listeners...");
                if (this.elements.themeToggle) this.elements.themeToggle.addEventListener('click', this.toggleTheme);
                if (this.elements.themeToggleLoggedOut) this.elements.themeToggleLoggedOut.addEventListener('click', this.toggleTheme); // Listener for logged-out toggle
                if (this.elements.tabOsint) this.elements.tabOsint.addEventListener('click', () => this.switchView('osint-view'));
                if (this.elements.tabChecklist) this.elements.tabChecklist.addEventListener('click', () => this.switchView('checklist-view'));

                if (this.elements.searchForm) this.elements.searchForm.addEventListener('submit', this.handleOsintSubmit);
                if (this.elements.clearButton) this.elements.clearButton.addEventListener('click', this.clearOsintResults);
                 if (this.elements.accordionContainer) this.elements.accordionContainer.addEventListener('click', this.handleAccordionClick);
                if (this.elements.startChecklistFromOsintBtn) this.elements.startChecklistFromOsintBtn.addEventListener('click', this.startChecklistFromOsint);

                // Sign out button in header
                if (this.elements.signOutBtnHeader) this.elements.signOutBtnHeader.addEventListener('click', this.handleSignOut); 

                // --- Login View Listeners ---
                if (this.elements.emailLoginForm) this.elements.emailLoginForm.addEventListener('submit', this.handleEmailLogin);
                if (this.elements.emailSignupBtn) this.elements.emailSignupBtn.addEventListener('click', this.handleEmailSignUp);
                if (this.elements.googleSigninBtn) this.elements.googleSigninBtn.addEventListener('click', this.handleGoogleSignIn);

                // --- Checklist Listeners (remain the same) ---
                if (this.elements.newChecklistBtn) this.elements.newChecklistBtn.addEventListener('click', () => this.renderChecklistForm(null));
                if (this.elements.backToListBtn) this.elements.backToListBtn.addEventListener('click', () => {
                    if (this.state.currentChecklistUnsubscribe) {
                        this.state.currentChecklistUnsubscribe();
                        this.state.currentChecklistUnsubscribe = null; 
                    }
                    this.showChecklistSubView('list');
                    this.listenForChecklists(); 
                });
                if (this.elements.saveChecklistBtn) this.elements.saveChecklistBtn.addEventListener('click', () => this.handleSaveChecklist(true));
                if (this.elements.deleteChecklistBtn) this.elements.deleteChecklistBtn.addEventListener('click', this.handleDeleteChecklist);
                if (this.elements.shareChecklistBtn) this.elements.shareChecklistBtn.addEventListener('click', this.handleManageSharing);
                if (this.elements.addMemberForm) this.elements.addMemberForm.addEventListener('submit', this.handleAddMember);
                 if (this.elements.shareMembersList) this.elements.shareMembersList.addEventListener('click', (e) => {
                     if (e.target.closest('.remove-member-btn')) {
                         const memberId = e.target.closest('.remove-member-btn').dataset.memberId;
                         this.handleRemoveMember(memberId);
                    }
                });
                if (this.elements.checklistSearchInput) this.elements.checklistSearchInput.addEventListener('input', this.filterAndRenderListView);
                if (this.elements.checklistOrgNameInput) this.elements.checklistOrgNameInput.addEventListener('input', () => {
                   if (this.elements.checklistTitle) this.elements.checklistTitle.textContent = this.elements.checklistOrgNameInput.value.trim() || "New Checklist";
                    this.updateDynamicToolLinks();
                    this.handleSaveChecklist(false);
                });
                if (this.elements.checklistSummaryNotes) this.elements.checklistSummaryNotes.addEventListener('input', () => this.handleSaveChecklist(false));
                if (this.elements.addCategoryBtn) this.elements.addCategoryBtn.addEventListener('click', this.addCategory);
                if (this.elements.checklistItemsContainer) {
                    this.elements.checklistItemsContainer.addEventListener('click', this.handleChecklistContainerClick);
                    this.elements.checklistItemsContainer.addEventListener('input', this.handleChecklistContainerInput);
                    this.elements.checklistItemsContainer.addEventListener('change', this.handleChecklistContainerChange);
                }
                
                // Modals
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => { if (e.target === modal) this.closeModal(modal); });
                    modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => btn.addEventListener('click', () => this.closeModal(modal)));
                });
                if (this.elements.modalConfirmBtn) this.elements.modalConfirmBtn.addEventListener('click', () => {
                    this.state.confirmAction?.();
                    if (this.elements.confirmationModal) this.closeModal(this.elements.confirmationModal);
                });
                 console.log("[UI] Event listeners set up.");
            },

            // --- THEME & VIEW MANAGEMENT ---
            
            initTheme() {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const savedTheme = localStorage.getItem('theme');
                 
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                } else {
                     document.documentElement.classList.remove('dark');
                }
                 this.updateThemeIcons(); 
            },
            
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                 this.updateThemeIcons(); 
            },
            
             updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                // Update both potential theme toggles
                 [this.elements.themeToggle, this.elements.themeToggleLoggedOut].forEach(toggle => {
                    if (toggle) {
                        const sunIcon = toggle.querySelector('[data-lucide="sun"]');
                        const moonIcon = toggle.querySelector('[data-lucide="moon"]');
                        if (sunIcon) sunIcon.style.display = isDark ? 'none' : 'block';
                        if (moonIcon) moonIcon.style.display = isDark ? 'block' : 'none';
                    }
                 });
            },
            
            switchView(viewId) {
                 // Only switch if user is logged in (auth is ready and user exists)
                 if (!this.state.isAuthReady || !this.state.userId) {
                    console.log("[UI] Prevented view switch - user not logged in.");
                    return; 
                 }
                this.state.currentView = viewId;
                document.querySelectorAll('.view-content').forEach(el => {
                    if (el.id !== 'login-view') el.classList.add('hidden'); // Ensure login view remains hidden
                });
                const viewElement = document.getElementById(viewId);
                 if(viewElement) viewElement.classList.remove('hidden');

                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                 const tabElement = document.getElementById(`tab-${viewId.split('-')[0]}`);
                 if(tabElement) tabElement.classList.add('active');
            },
            
            showChecklistSubView(subView) {
                 if(this.elements.checklistListView) this.elements.checklistListView.classList.toggle('hidden', subView !== 'list');
                 if(this.elements.checklistEditorView) this.elements.checklistEditorView.classList.toggle('hidden', subView !== 'editor');
            },

            // --- OSINT TOOL LOGIC (Remains largely the same) ---

            handleOsintSubmit(e) {
                e.preventDefault();
                this.elements.generateButton.disabled = true;
                this.elements.generateButton.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Generating...</span>`;
                lucide.createIcons();
                this.elements.placeholder.classList.add('hidden');
                this.elements.skeletonContainer.classList.remove('hidden');

                setTimeout(() => {
                    const inputs = {
                        orgName: this.elements.orgName.value.trim(),
                        personName: this.elements.personName.value.trim(),
                        orgEin: this.elements.orgEin.value.trim(),
                        location: this.elements.location.value.trim(),
                        domainName: this.elements.domainName.value.trim(),
                        socialHandle: this.elements.socialHandle.value.trim(),
                        selectedState: this.elements.stateSelect.value,
                    };
                    if (!inputs.orgName) {
                        this.elements.errorMessage.textContent = 'Organization name is required.';
                        this.elements.errorMessage.classList.remove('hidden');
                        this.resetGenerateButton();
                        this.elements.skeletonContainer.classList.add('hidden');
                        this.elements.placeholder.classList.remove('hidden');
                        return;
                    }
                    this.elements.errorMessage.classList.add('hidden');
                    
                    const sections = this.buildLinkSections(inputs);
                    this.renderOsintResults(inputs.orgName, sections);
                    this.elements.skeletonContainer.classList.add('hidden');
                }, 500); // Shorter timeout as it's just link generation
            },

            startChecklistFromOsint() {
                const orgName = this.elements.orgName.value.trim();
                if (!orgName) {
                    this.showToast("Please enter an organization name first.", "error");
                    return;
                }
                 // Ensure user is logged in before switching
                 if (!this.state.isAuthReady || !this.state.userId) {
                    this.showToast("Please sign in to use checklists.", "error");
                     // Optionally, show login view or prompt
                    return; 
                 }
                this.switchView('checklist-view');
                this.renderChecklistForm(null, orgName);
            },

            buildLinkSections(inputs) {
                // This function remains the same as before
                const { orgName, personName, orgEin, location, domainName, socialHandle, selectedState } = inputs;
                const encodedOrgName = encodeURIComponent(orgName);
                const plusEncodedOrgName = orgName.replace(/\s/g, '+');
                const einWithoutHyphen = orgEin.replace(/-/g, '');
                const sections = [];

                if (selectedState && this.data.stateResources && this.data.stateResources[selectedState]) {
                    sections.push({
                        id: 'state', title: `${this.data.states[selectedState]} State-Level`, icon: 'building-2', isOpen: true,
                        links: this.data.stateResources[selectedState].map(r => ({ name: r.n, url: r.u }))
                    });
                }

                sections.push({
                    id: 'financial', title: 'Federal Financial & Legal', icon: 'landmark', isOpen: true,
                    links: [
                        { name: 'IRS Tax Exempt Org Search', url: 'https://apps.irs.gov/app/eos/' },
                        { name: 'ProPublica Nonprofit Explorer', url: orgEin ? `https://projects.propublica.org/nonprofits/organizations/${einWithoutHyphen}` : `https://projects.propublica.org/nonprofits/search?q=${plusEncodedOrgName}` },
                        { name: 'Candid (Guidestar)', url: `https://candid.org/search?q=${orgEin || encodedOrgName}` },
                    ]
                });
                
                sections.push({
                    id: 'news', title: 'News & Public Perception', icon: 'newspaper', isOpen: false,
                    links: [
                        { name: 'Google News', url: `https://www.google.com/search?q=%22${encodedOrgName}%22&tbm=nws` },
                        { name: 'Google Reviews Search', url: `https://www.google.com/search?q=%22${encodedOrgName}%22+reviews` },
                        { name: 'Reddit Search', url: `https://www.reddit.com/search/?q=%22${encodedOrgName}%22` },
                        { name: 'Better Business Bureau', url: `https://www.bbb.org/search?find_text=${encodedOrgName}` },
                    ]
                });

                return sections;
            },

            renderOsintResults(orgName, sections) {
                this.elements.resultsTitle.textContent = `Investigation for: "${orgName}"`;
                const sectionsHtml = sections.map(s => this.createAccordionSectionHTML(s.id, s.title, s.icon, s.links, s.isOpen)).join('');
                this.elements.accordionContainer.innerHTML = sectionsHtml;
                this.elements.placeholder.classList.add('hidden-fade');
                this.elements.resultsContainer.classList.remove('hidden-fade');
                this.elements.resultsContainer.classList.add('visible-fade');
                this.resetGenerateButton();
                lucide.createIcons();
            },
            
            clearOsintResults() {
                 this.elements.searchForm.reset();
                 this.elements.resultsContainer.classList.remove('visible-fade');
                 this.elements.resultsContainer.classList.add('hidden-fade');
                 setTimeout(() => {
                    this.elements.accordionContainer.innerHTML = '';
                    this.elements.resultsTitle.textContent = '';
                    this.elements.placeholder.classList.remove('hidden-fade');
                    this.elements.placeholder.classList.remove('hidden');
                }, 500);
            },
            
            resetGenerateButton() {
                 this.elements.generateButton.disabled = false;
                 this.elements.generateButton.innerHTML = `<i data-lucide="search" class="w-5 h-5"></i><span>Generate</span>`;
                 lucide.createIcons();
            },
            
            // --- CHECKLIST APP LOGIC (Remains largely the same, relies on userId) ---
            
            listenForChecklists() {
                 if (!this.firebase.db) {
                    console.error("[Firestore] Database not initialized. Cannot listen.");
                    return;
                }
                if (this.state.listUnsubscribe) {
                    console.log("[Firestore] Detaching previous checklist listener.");
                    this.state.listUnsubscribe();
                    this.state.listUnsubscribe = null;
                }
                
                // *** IMPORTANT: Now requires logged-in user ***
                if (!this.state.isAuthReady || !this.state.userId) {
                    console.warn("[Firestore] Auth not ready or user not logged in, cannot listen for checklists.");
                    this.renderListView([]); // Clear list display
                    if(this.elements.noChecklistsMessage) {
                        this.elements.noChecklistsMessage.classList.remove('hidden'); 
                        this.elements.noChecklistsMessage.innerHTML = `<div class="flex flex-col items-center"><i data-lucide="log-in" class="w-20 h-20 text-gray-400 mb-4"></i><p class="text-xl font-semibold">Please Sign In</p><p class="text-sm">Sign in to view or create checklists.</p></div>`;
                        lucide.createIcons();
                    }
                    if (this.elements.checklistLoadingView) this.elements.checklistLoadingView.classList.add('hidden'); // Hide loading spinner if shown
                    if (this.elements.checklistMainContent) this.elements.checklistMainContent.classList.remove('hidden'); // Show main (which contains the message)
                    return;
                }
                
                // Show loading view while fetching
                if (this.elements.checklistLoadingView) this.elements.checklistLoadingView.classList.remove('hidden');
                if (this.elements.checklistMainContent) this.elements.checklistMainContent.classList.add('hidden');


                console.log(`[Firestore] Setting up checklist listener for user: ${this.state.userId}`);
                const checklistsCollectionPath = `artifacts/${this.firebase.appId}/checklists`;
                console.log("[Firestore] Querying collection:", checklistsCollectionPath); 

                const q = query(
                     collection(this.firebase.db, checklistsCollectionPath), 
                    where('memberIds', 'array-contains', this.state.userId)
                    // Consider adding: orderBy('lastUpdated', 'desc') - Requires Index
                );
                
                this.state.listUnsubscribe = onSnapshot(q, (querySnapshot) => {
                     console.log("[Firestore] Checklist snapshot received:", querySnapshot.docs.length, "docs");
                    const checklists = [];
                    querySnapshot.forEach((doc) => {
                        checklists.push({ id: doc.id, ...doc.data() });
                    });
                    
                     // Hide loading, show content AFTER data received
                     if (this.elements.checklistLoadingView) this.elements.checklistLoadingView.classList.add('hidden');
                     if (this.elements.checklistMainContent) this.elements.checklistMainContent.classList.remove('hidden');
                     this.showChecklistSubView('list'); // Ensure list view is shown

                    this.renderListView(checklists); 
                     if (this.elements.statusMessage && this.elements.statusMessage.textContent.includes("Could not load")) {
                        this.showStatus(this.elements.statusMessage, "", 'info', 0);
                     }
                }, (error) => {
                    console.error("[Firestore] Error listening for checklists:", error);
                     const errorElement = this.elements.statusMessage || this.elements.checklistAuthError; 
                     const displayError = (msg) => {
                         if (errorElement) this.showStatus(errorElement, msg, 'error', null);
                         if (this.elements.noChecklistsMessage) {
                             this.elements.noChecklistsMessage.innerHTML = `<div class="flex flex-col items-center"><i data-lucide="alert-triangle" class="w-20 h-20 text-red-400 mb-4"></i><p class="text-xl font-semibold">Error Loading Checklists</p><p class="text-sm">${msg}</p></div>`;
                             this.elements.noChecklistsMessage.classList.remove('hidden');
                             lucide.createIcons();
                         }
                         if (this.elements.checklistLoadingView) this.elements.checklistLoadingView.classList.add('hidden'); // Hide loading on error
                         if (this.elements.checklistMainContent) this.elements.checklistMainContent.classList.remove('hidden'); // Show main content (with error message)
                         this.showChecklistSubView('list'); // Ensure list view is visible to show error
                         this.renderListView([]); 
                     };

                    if (error.code === 'permission-denied') { 
                        displayError("Permission denied. Please check Firestore security rules.");
                    } else if (error.code === 'failed-precondition') {
                         displayError("Query failed. This often means a required Firestore index is missing. Check the developer console for a link to create it.");
                    } else {
                         displayError(`Error loading checklists: ${error.message}`);
                    }
                });
            },

            // renderChecklistForm, buildChecklistUI, updateChecklistPermissions, handleSaveChecklist, 
            // handleAddMember, handleRemoveMember, renderListView, filterAndRenderListView, 
            // renderCategoryHTML, renderItemHTML, handleChecklistContainer*, addItem, addCategory,
            // handleDeleteChecklist, handleManageSharing, populateMembersList
            // -- These checklist functions remain the same as they already depend on this.state.userId --
            // --- Make sure they use the correct Firestore paths with appId ---
             renderChecklistForm(checklistId = null, prefilledOrgName = '') {
                 if (!this.firebase.db) {
                     console.error("[Firestore] Database not initialized. Cannot render form.");
                     return;
                 }
                // --- Ensure user is logged in before allowing creation/edit ---
                if (!this.state.isAuthReady || !this.state.userId) {
                    this.showToast("Please sign in to manage checklists.", "error");
                    this.switchView('osint-view'); // Switch back to OSINT or show login
                    return;
                }
                 
                if (this.state.listUnsubscribe) { 
                     console.log("[Firestore] Detaching list listener to open editor.");
                     this.state.listUnsubscribe();
                     this.state.listUnsubscribe = null;
                 }
                if (this.state.currentChecklistUnsubscribe) { 
                     console.log("[Firestore] Detaching existing editor listener.");
                     this.state.currentChecklistUnsubscribe();
                     this.state.currentChecklistUnsubscribe = null;
                 }
                
                 if (this.elements.checklistItemsContainer) this.elements.checklistItemsContainer.innerHTML = '';
                this.state.currentChecklistData = null;
                 const checklistsCollectionPath = `artifacts/${this.firebase.appId}/checklists`; 

                if (checklistId) {
                     const docPath = `${checklistsCollectionPath}/${checklistId}`;
                     console.log("[Firestore] Attaching listener to doc:", docPath);
                    this.state.currentChecklistUnsubscribe = onSnapshot(doc(this.firebase.db, docPath), (doc) => {
                         console.log("[Firestore] Single checklist snapshot received. Exists:", doc.exists());
                        if (!doc.exists()) {
                            this.showStatus(this.elements.statusMessage, "Checklist not found.", 'error');
                            this.showChecklistSubView('list');
                            this.listenForChecklists();
                            return;
                        }
                        
                        const data = { id: doc.id, ...doc.data() };
                        const role = data.members ? data.members[this.state.userId] : null; 
                        if (!role) {
                             console.warn(`[Auth] User ${this.state.userId} not found in members of ${checklistId}`);
                            this.showStatus(this.elements.statusMessage, "Access denied.", 'error');
                            this.showChecklistSubView('list');
                            this.listenForChecklists();
                            return;
                        }
                        
                        this.state.currentChecklistData = data;
                        this.buildChecklistUI(data);
                        this.updateChecklistPermissions(data, role);
                    }, (error) => { 
                        console.error("[Firestore] Error fetching checklist details:", error);
                        this.showStatus(this.elements.statusMessage, "Error loading checklist details.", 'error');
                        this.showChecklistSubView('list');
                        this.listenForChecklists(); // Go back to list on error
                    });
                } else {
                     console.log("[App] Creating new checklist form data.");
                    this.state.currentChecklistData = {
                        id: null, orgName: prefilledOrgName,
                        categories: JSON.parse(JSON.stringify(this.getChecklistMasterTemplate())),
                        summary: '', members: { [this.state.userId]: 'owner' },
                        memberIds: [this.state.userId] 
                    };
                    this.buildChecklistUI(this.state.currentChecklistData);
                    this.updateChecklistPermissions(this.state.currentChecklistData, 'owner');
                }
                this.showChecklistSubView('editor');
            },

            buildChecklistUI(data) {
                 if (!this.elements.checklistItemsContainer || !this.elements.checklistSummaryNotes) return;
                this.elements.checklistItemsContainer.innerHTML = '';
                (data.categories || []).forEach(category => {
                    const categoryEl = document.createElement('div');
                    categoryEl.innerHTML = this.renderCategoryHTML(category);
                    this.elements.checklistItemsContainer.appendChild(categoryEl.firstElementChild);
                });
                this.elements.checklistSummaryNotes.value = data.summary || '';
                this.updateDynamicToolLinks();
                 lucide.createIcons();
            },

            updateChecklistPermissions(data, role) {
                const isViewer = role === 'viewer';
                const isOwner = role === 'owner';
                
                 if (this.elements.checklistOrgNameInput) this.elements.checklistOrgNameInput.value = data.orgName || '';
                 if (this.elements.checklistTitle) this.elements.checklistTitle.textContent = data.orgName || 'New Checklist';
                
                 if (this.elements.deleteChecklistBtn) this.elements.deleteChecklistBtn.classList.toggle('hidden', !isOwner || !data.id);
                 if (this.elements.shareChecklistBtn) this.elements.shareChecklistBtn.classList.toggle('hidden', !isOwner || !data.id);
                 if (this.elements.saveChecklistBtn) this.elements.saveChecklistBtn.classList.toggle('hidden', isViewer);
                 if (this.elements.addCategoryBtn) this.elements.addCategoryBtn.classList.toggle('hidden', isViewer);
                
                 if (this.elements.checklistOrgNameInput) this.elements.checklistOrgNameInput.disabled = isViewer;
                 if (this.elements.checklistSummaryNotes) this.elements.checklistSummaryNotes.disabled = isViewer;

                 if (this.elements.checklistItemsContainer) {
                    this.elements.checklistItemsContainer.querySelectorAll('input:not([type="checkbox"]), textarea, button:not([data-action="toggle-category"])').forEach(el => {
                        el.disabled = isViewer;
                    });
                     // Checkboxes should reflect state but might not be disabled depending on desired UX for viewers
                     this.elements.checklistItemsContainer.querySelectorAll('input[type="checkbox"]').forEach(el => {
                         el.disabled = isViewer; // Disable changing state for viewers
                     });
                     // Hide action buttons for viewers
                     this.elements.checklistItemsContainer.querySelectorAll('.add-item-button').forEach(el => el.classList.toggle('hidden', isViewer));
                }
            },

            async handleSaveChecklist(force = false) {
                clearTimeout(this.state.saveTimeout);
                const saveAction = async () => {
                    if (!this.state.userId || !this.state.currentChecklistData) {
                        console.warn("[Firestore] Save attempted without user or data.");
                        return;
                     }
                      if (!this.firebase.db) {
                        console.error("[Firestore] Save failed: Database not initialized.");
                        this.showStatus(this.elements.statusMessage, "Error: Database connection lost.", 'error');
                        return;
                    }

                    const orgName = this.elements.checklistOrgNameInput.value.trim();
                    if (!orgName) {
                        this.elements.checklistOrgNameError.classList.remove('hidden');
                        return;
                    }
                    this.elements.checklistOrgNameError.classList.add('hidden');
                    
                    this.state.currentChecklistData.orgName = orgName;
                    this.state.currentChecklistData.summary = this.elements.checklistSummaryNotes.value;
                    
                    // Ensure members and memberIds are correctly set/updated
                    const currentMembers = this.state.currentChecklistData.members || { [this.state.userId]: 'owner' };
                    const memberIds = Object.keys(currentMembers);
                     this.state.currentChecklistData.members = currentMembers; // Update local state
                     this.state.currentChecklistData.memberIds = memberIds;   // Update local state


                    const dataToSave = {
                        orgName: this.state.currentChecklistData.orgName,
                        categories: this.state.currentChecklistData.categories || [],
                        summary: this.state.currentChecklistData.summary || '',
                        members: currentMembers, // Use updated map
                        memberIds: memberIds,    // Use updated array
                        lastUpdated: serverTimestamp()
                    };
                     const checklistsCollectionPath = `artifacts/${this.firebase.appId}/checklists`; 

                    this.setSaveButtonState(true);
                    try {
                        let docRef;
                        let docPath;
                        if (this.state.currentChecklistData.id) {
                            // Update existing document
                            docPath = `${checklistsCollectionPath}/${this.state.currentChecklistData.id}`;
                            console.log("[Firestore] Updating existing checklist at:", docPath); 
                            docRef = doc(this.firebase.db, docPath);
                            await updateDoc(docRef, dataToSave);
                        } else {
                             // Create new document - Ensure initial owner/memberIds are set
                            dataToSave.members = { [this.state.userId]: 'owner' };
                            dataToSave.memberIds = [this.state.userId];
                            console.log("[Firestore] Creating new checklist in:", checklistsCollectionPath, "with data:", dataToSave); 
                            docRef = await addDoc(collection(this.firebase.db, checklistsCollectionPath), dataToSave);
                            
                            const newChecklistId = docRef.id;
                            console.log("[Firestore] New checklist created with ID:", newChecklistId);

                            // Critical: Update local state with the new ID and correct members info
                            this.state.currentChecklistData.id = newChecklistId; 
                            this.state.currentChecklistData.members = dataToSave.members; 
                            this.state.currentChecklistData.memberIds = dataToSave.memberIds; 

                            // Detach any previous listener (should be null, but safe check)
                            if (this.state.currentChecklistUnsubscribe) this.state.currentChecklistUnsubscribe(); 

                            // Attach listener to the newly created document
                            const newDocPath = `${checklistsCollectionPath}/${newChecklistId}`;
                            console.log("[Firestore] Attaching listener to newly created doc:", newDocPath);
                            this.state.currentChecklistUnsubscribe = onSnapshot(doc(this.firebase.db, newDocPath), (/* updatedDoc */) => {
                                // We might receive the initial write back, log it
                                console.log(`[Firestore] Listener attached and received update for ${newChecklistId}`);
                                // Re-render or update permissions if needed based on updatedDoc.data()
                                // For now, just logging is fine as the main update happened locally.
                            }, (error) => {
                                console.error(`[Firestore] Error attaching listener to new checklist ${newChecklistId}:`, error);
                            });
                             
                             // Update UI elements that depend on the ID (like share/delete buttons)
                            this.updateChecklistPermissions(this.state.currentChecklistData, 'owner'); 
                        }
                        this.showStatus(this.elements.statusMessage, "Checklist saved!", 'success');
                    } catch (error) {
                        console.error("[Firestore] Error saving checklist: ", error);
                         if (error.code === 'permission-denied') {
                             this.showStatus(this.elements.statusMessage, "Permission denied. Check Firestore rules.", 'error', null);
                        } else {
                            this.showStatus(this.elements.statusMessage, `Error saving: ${error.message}`, 'error', null);
                        }
                    } finally {
                        this.setSaveButtonState(false);
                    }
                };
                if (force) { await saveAction(); } 
                else { this.state.saveTimeout = setTimeout(saveAction, 1500); }
            },
            
            async handleAddMember(e) {
                e.preventDefault();
                 if (!this.firebase.db) return;
                const newMemberId = this.elements.addMemberId.value.trim();
                const role = this.elements.addMemberRole.value;
                 if (!newMemberId || !this.state.currentChecklistData || !this.state.currentChecklistData.id) return;
                 
                 this.showStatus(this.elements.shareStatusMessage, "Adding member...", 'info', null);

                try {
                    if (this.state.currentChecklistData.members && this.state.currentChecklistData.members[newMemberId]) {
                        throw new Error("User is already a member.");
                    }
                    
                    const checklistsCollectionPath = `artifacts/${this.firebase.appId}/checklists`; 
                    const checklistRef = doc(this.firebase.db, checklistsCollectionPath, this.state.currentChecklistData.id);
                    
                    // Firestore update using dot notation for map field and arrayUnion for array field
                    await updateDoc(checklistRef, {
                        [`members.${newMemberId}`]: role,         // Add to members map
                        memberIds: arrayUnion(newMemberId)      // Add to memberIds array
                    });

                    // --- Update local state AFTER successful DB update ---
                    if (!this.state.currentChecklistData.members) this.state.currentChecklistData.members = {};
                    this.state.currentChecklistData.members[newMemberId] = role;
                    if (!this.state.currentChecklistData.memberIds) this.state.currentChecklistData.memberIds = [];
                    // Avoid duplicate adds locally if somehow already there
                    if (!this.state.currentChecklistData.memberIds.includes(newMemberId)) {
                        this.state.currentChecklistData.memberIds.push(newMemberId);
                    }
                    
                    this.showStatus(this.elements.shareStatusMessage, "Member added!", 'success');
                    this.elements.addMemberId.value = '';
                    this.populateMembersList(); // Refresh the list in the modal
                } catch (error) {
                    console.error("Error adding member:", error);
                     if (error.code === 'permission-denied') {
                        this.showStatus(this.elements.shareStatusMessage, `Error: Permission denied. Only owners can add members.`, 'error');
                     } else {
                        this.showStatus(this.elements.shareStatusMessage, `Error adding member: ${error.message}`, 'error');
                    }
                }
            },

            async handleRemoveMember(memberId) {
                 if (!this.firebase.db) return;
                 if (!memberId || !this.state.currentChecklistData || !this.state.currentChecklistData.id || memberId === this.state.userId) return; 
                 if (!this.state.currentChecklistData.members || this.state.currentChecklistData.members[this.state.userId] !== 'owner') {
                     this.showStatus(this.elements.shareStatusMessage, "Only the owner can remove members.", 'error');
                     return;
                 }
                 
                 this.showStatus(this.elements.shareStatusMessage, "Removing member...", 'info', null);

                 try {
                     const checklistsCollectionPath = `artifacts/${this.firebase.appId}/checklists`; 
                    const checklistRef = doc(this.firebase.db, checklistsCollectionPath, this.state.currentChecklistData.id);
                    
                    // Use deleteField for map key and arrayRemove for array element
                    await updateDoc(checklistRef, {
                        [`members.${memberId}`]: deleteField(), // Remove from members map
                        memberIds: arrayRemove(memberId)      // Remove from memberIds array
                    });

                    // --- Update local state AFTER successful DB update ---
                    if (this.state.currentChecklistData.members) {
                        delete this.state.currentChecklistData.members[memberId];
                    }
                    if (this.state.currentChecklistData.memberIds) {
                        this.state.currentChecklistData.memberIds = this.state.currentChecklistData.memberIds.filter(id => id !== memberId);
                    }

                    this.showStatus(this.elements.shareStatusMessage, "Member removed!", 'success');
                    this.populateMembersList(); // Refresh the list in the modal
                } catch (error) {
                     console.error("Error removing member:", error);
                      if (error.code === 'permission-denied') {
                         this.showStatus(this.elements.shareStatusMessage, `Error: Permission denied. Only owners can remove members.`, 'error');
                      } else {
                         this.showStatus(this.elements.shareStatusMessage, `Error removing member: ${error.message}`, 'error');
                     }
                }
            },
            
            renderListView(checklists) {
                const container = this.elements.savedChecklistsContainer;
                 if (!container) return; 
                container.innerHTML = '';
                 if(this.elements.noChecklistsMessage) {
                    this.elements.noChecklistsMessage.classList.toggle('hidden', checklists.length > 0);
                     // Reset message content if it was an error
                     if (this.elements.noChecklistsMessage.textContent.includes("Error") || this.elements.noChecklistsMessage.textContent.includes("Sign In")) {
                         this.elements.noChecklistsMessage.innerHTML = `<div class="flex flex-col items-center"><i data-lucide="file-x" class="w-20 h-20 text-gray-400 mb-4"></i><p class="text-xl font-semibold">No Checklists Found</p><p class="text-sm">Click "Start New" to create one.</p></div>`;
                        lucide.createIcons();
                    }
                 }

                const sortedChecklists = checklists.sort((a, b) => (b.lastUpdated?.toDate() || 0) - (a.lastUpdated?.toDate() || 0));

                sortedChecklists.forEach(list => {
                    const card = document.createElement('div');
                    card.className = 'p-5 bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-transparent hover:border-indigo-500/50';
                    card.dataset.id = list.id;
                    card.addEventListener('click', () => this.renderChecklistForm(list.id));
                    
                    const lastUpdated = list.lastUpdated ? list.lastUpdated.toDate().toLocaleString() : 'N/A';
                    const role = list.members && this.state.userId ? list.members[this.state.userId] : 'Unknown'; // Check userId exists

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white truncate pr-4">${list.orgName || 'Untitled Checklist'}</h3>
                            <span class="flex-shrink-0 text-xs font-semibold uppercase px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">${role}</span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Last updated: ${lastUpdated}</p>
                    `;
                    container.appendChild(card);
                });
                this.filterAndRenderListView();
            },
            
            filterAndRenderListView() {
                 if (!this.elements.checklistSearchInput || !this.elements.savedChecklistsContainer || !this.elements.noChecklistsMessage) return; 
                const searchTerm = this.elements.checklistSearchInput.value.toLowerCase();
                const cards = this.elements.savedChecklistsContainer.querySelectorAll('[data-id]');
                let visibleCount = 0;
                cards.forEach(card => {
                    const titleElement = card.querySelector('h3');
                     const title = titleElement ? titleElement.textContent.toLowerCase() : '';
                    const isVisible = title.includes(searchTerm);
                    card.style.display = isVisible ? '' : 'none';
                    if (isVisible) visibleCount++;
                });
                 // Check if *any* cards exist, even if hidden by filter
                 const hasAnyCardsAtAll = this.elements.savedChecklistsContainer.children.length > 0;
                 // Determine if the "no checklists" message should show
                 const shouldShowNoChecklists = !hasAnyCardsAtAll || (hasAnyCardsAtAll && visibleCount === 0);
                
                // Only hide the message if it's NOT displaying an error/login prompt
                if (!this.elements.noChecklistsMessage.textContent.includes("Error") && !this.elements.noChecklistsMessage.textContent.includes("Sign In")) {
                    this.elements.noChecklistsMessage.classList.toggle('hidden', !shouldShowNoChecklists);
                }

             },

            renderCategoryHTML(category) {
                 return `
                    <div class="category-block bg-gray-50/50 dark:bg-gray-800/50 rounded-lg border border-gray-200/80 dark:border-gray-700/80 expanded" data-category-id="${category.id}">
                        <div class="flex justify-between items-center p-4 cursor-pointer" data-action="toggle-category">
                            <h3 class="category-title text-xl font-semibold text-gray-700 dark:text-gray-300">${category.name}</h3>
                            <i data-lucide="chevron-down" class="category-toggle-icon text-gray-500 chevron-icon transform rotate-180"></i>
                        </div>
                        <div class="category-content open px-4 pb-4">
                             <div class="space-y-5 border-t border-gray-200 dark:border-gray-700 pt-4">
                                ${ (category.items || []).map(item => this.renderItemHTML(item, category.id)).join('')}
                                <button class="add-item-button mt-4 w-full text-sm btn btn-secondary" data-action="add-item">Add Item</button>
                            </div>
                        </div>
                    </div>`;
            },
            
            renderItemHTML(item, categoryId) {
                const toolButtonHtml = item.link ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer" class="contextual-tool-button mt-1.5 flex items-center space-x-2 text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-base-url="${item.link}"><i data-lucide="external-link" class="h-4 w-4"></i><span>${item.linkText || 'Open Tool'}</span></a>` : '';
                return `
                    <div class="checklist-item border-b border-gray-100 dark:border-gray-700/50 pb-4 last:border-b-0" data-item-id="${item.id}" data-category-id="${categoryId}">
                        <div class="flex items-start space-x-4">
                            <input type="checkbox" id="check-${item.id}" class="custom-checkbox mt-1" data-action="check-item" ${item.checked ? 'checked' : ''}>
                            <label for="check-${item.id}" class="item-text flex-1 text-gray-700 dark:text-gray-300 cursor-pointer">${item.text}</label>
                        </div>
                        <div class="pl-10 mt-2 space-y-3">
                             ${toolButtonHtml}
                            <textarea class="notes-input w-full p-2 text-sm border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" data-action="update-note" placeholder="Add notes...">${item.notes || ''}</textarea>
                        </div>
                    </div>`;
             },
             
            // --- HELPERS & UTILITIES ---
            
            closeModal(modalElement) {
                if (modalElement) modalElement.style.display = 'none';
            },

            openConfirmationModal(title, message, onConfirm) {
                 if (!this.elements.confirmationModal || !this.elements.modalTitle || !this.elements.modalMessage) return;
                this.elements.modalTitle.textContent = title;
                this.elements.modalMessage.textContent = message;
                this.state.confirmAction = onConfirm; // Store the action
                this.elements.confirmationModal.style.display = 'block';
            },
            
             updateDynamicToolLinks() {
                 if (!this.elements.checklistOrgNameInput || !this.elements.checklistItemsContainer) return;
                const orgName = this.elements.checklistOrgNameInput.value.trim();
                // Don't clear links if name is empty, just don't update them
                if (!orgName) return; 

                const encodedOrgName = encodeURIComponent(orgName);
                const toolLinks = this.elements.checklistItemsContainer.querySelectorAll('a.contextual-tool-button[data-base-url]');

                toolLinks.forEach(link => {
                    const baseUrl = link.dataset.baseUrl;
                    // Ensure the base URL ends appropriately before appending
                    if (baseUrl.includes('q=') || baseUrl.includes('query=') || baseUrl.includes('find_text=')) {
                        link.href = `${baseUrl}${encodedOrgName}`;
                    } else {
                        // If it's just a base domain or path, append appropriately (might need adjustment based on specific tool URL structure)
                         link.href = `${baseUrl}${encodedOrgName}`; // Simple append, adjust if needed
                    }
                });
             },

              handleSignOut() {
                 if (!this.firebase.auth) return;
                signOut(this.firebase.auth).then(() => {
                    console.log("[Auth] Sign out successful.");
                    // Clear local state immediately for faster UI update before onAuthStateChanged triggers
                    this.state.isAuthReady = false;
                    this.state.userId = null;
                    if (this.state.listUnsubscribe) this.state.listUnsubscribe();
                    if (this.state.currentChecklistUnsubscribe) this.state.currentChecklistUnsubscribe();
                    this.state.listUnsubscribe = null;
                    this.state.currentChecklistUnsubscribe = null;
                    this.state.currentChecklistData = null;
                    this.renderListView([]); // Clear UI immediately
                    // onAuthStateChanged will handle showing the login screen
                }).catch(error => console.error("[Auth] Sign out error", error));
            },

            // --- NEW AUTH HANDLERS ---
            handleEmailLogin(e) {
                e.preventDefault();
                if (!this.firebase.auth || !this.elements.loginEmail || !this.elements.loginPassword || !this.elements.loginErrorMessage) return;
                const email = this.elements.loginEmail.value;
                const password = this.elements.loginPassword.value;
                
                // Show loading/disable button (optional)
                this.elements.loginErrorMessage.classList.add('hidden'); // Hide previous errors

                signInWithEmailAndPassword(this.firebase.auth, email, password)
                    .then((userCredential) => {
                        console.log("Email login successful:", userCredential.user.uid);
                        // onAuthStateChanged will handle UI update
                    })
                    .catch((error) => {
                        this.elements.loginErrorMessage.textContent = `Login Failed: ${error.message}`;
                        this.elements.loginErrorMessage.classList.remove('hidden');
                        // Re-enable button (optional)
                    });
            },

            handleEmailSignUp(e) {
                e.preventDefault();
                 if (!this.firebase.auth || !this.elements.loginEmail || !this.elements.loginPassword || !this.elements.loginErrorMessage) return;
                const email = this.elements.loginEmail.value;
                const password = this.elements.loginPassword.value;

                // Show loading/disable button (optional)
                 this.elements.loginErrorMessage.classList.add('hidden'); // Hide previous errors

                createUserWithEmailAndPassword(this.firebase.auth, email, password)
                    .then((userCredential) => {
                        console.log("Email sign-up successful:", userCredential.user.uid);
                         // onAuthStateChanged will handle UI update
                    })
                    .catch((error) => {
                         this.elements.loginErrorMessage.textContent = `Sign Up Failed: ${error.message}`;
                        this.elements.loginErrorMessage.classList.remove('hidden');
                         // Re-enable button (optional)
                    });
            },

            handleGoogleSignIn() {
                 if (!this.firebase.auth || !this.elements.loginErrorMessage) return;
                const provider = new GoogleAuthProvider();
                 this.elements.loginErrorMessage.classList.add('hidden'); // Hide previous errors

                signInWithPopup(this.firebase.auth, provider)
                    .then((result) => {
                        console.log("Google login successful:", result.user.uid);
                        // onAuthStateChanged will handle UI update
                    })
                    .catch((error) => {
                         // Handle specific errors like popup blocked
                         if (error.code === 'auth/popup-blocked') {
                            this.elements.loginErrorMessage.textContent = 'Popup blocked by browser. Please allow popups for this site.';
                        } else if (error.code === 'auth/popup-closed-by-user') {
                             this.elements.loginErrorMessage.textContent = 'Sign-in window closed before completion.';
                        } else {
                            this.elements.loginErrorMessage.textContent = `Google Sign-In Error: ${error.message}`;
                        }
                        this.elements.loginErrorMessage.classList.remove('hidden');
                    });
            },
            
            // --- Other Checklist Handlers (Unchanged from previous versions) ---
            // handleChecklistContainerClick, handleChecklistContainerInput, handleChecklistContainerChange, 
            // addItem, addCategory, handleDeleteChecklist, handleManageSharing, populateMembersList
             handleChecklistContainerClick(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                const categoryEl = target.closest('.category-block');
                const itemEl = target.closest('.checklist-item');
                const categoryId = categoryEl?.dataset.categoryId;

                if (action === 'toggle-category' && categoryEl) {
                    // Find content and icon relative to the category element
                    const content = categoryEl.querySelector('.category-content');
                    const icon = categoryEl.querySelector('.category-toggle-icon');
                    
                    const isOpen = content && content.classList.contains('open');
                    
                    if (content) content.classList.toggle('open');
                    if (icon) icon.classList.toggle('rotate-180', !isOpen); // Add rotate class if it wasn't open
                    categoryEl.classList.toggle('expanded', !isOpen);

                } else if (action === 'add-item' && categoryId) {
                    this.addItem(categoryId);
                }
                // Add handlers for edit/delete later if needed
            },
            
             handleChecklistContainerInput(e) {
                const target = e.target.closest('[data-action="update-note"]');
                if (!target || !this.state.currentChecklistData) return;
                const itemEl = target.closest('.checklist-item');
                const categoryId = itemEl?.dataset.categoryId;
                const itemId = itemEl?.dataset.itemId;

                 const category = this.state.currentChecklistData.categories?.find(c => c.id === categoryId);
                 const item = category?.items?.find(i => i.id === itemId);
                 if (item) {
                     item.notes = target.value;
                     this.handleSaveChecklist(false); // Trigger auto-save
                 }
            },

             handleChecklistContainerChange(e) {
                const target = e.target.closest('[data-action="check-item"]');
                 if (!target || !this.state.currentChecklistData) return;
                 const itemEl = target.closest('.checklist-item');
                 const categoryId = itemEl?.dataset.categoryId;
                 const itemId = itemEl?.dataset.itemId;

                 const category = this.state.currentChecklistData.categories?.find(c => c.id === categoryId);
                 const item = category?.items?.find(i => i.id === itemId);
                 if (item) {
                     item.checked = target.checked;
                     this.handleSaveChecklist(true); // Force save on check change
                 }
            },
            
            addItem(categoryId) {
                 if (!this.state.currentChecklistData || !this.state.currentChecklistData.categories) return;
                 const category = this.state.currentChecklistData.categories.find(c => c.id === categoryId);
                 if (!category) return;

                 // Simple prompt for now, could use edit-modal later
                 const newItemText = prompt("Enter text for the new checklist item:", "New Item");
                 if (newItemText === null || newItemText.trim() === '') return; // User cancelled or entered empty


                 const newItem = { 
                     id: `item_${Date.now()}_${Math.random().toString(16).slice(2)}`, 
                     text: newItemText.trim(), 
                     isCustom: true, // Assuming items added this way are custom
                     checked: false, 
                     notes: "" 
                 };
                  if (!category.items) category.items = []; // Ensure items array exists
                 category.items.push(newItem);
                 this.buildChecklistUI(this.state.currentChecklistData); // Re-render the UI
                 this.handleSaveChecklist(true); // Force save
            },
            
            addCategory() {
                if (!this.state.currentChecklistData) return;
                 // Simple prompt for now
                 const newCategoryName = prompt("Enter name for the new category:", "New Category");
                 if (newCategoryName === null || newCategoryName.trim() === '') return;

                const newCategory = { 
                    id: `cat_${Date.now()}_${Math.random().toString(16).slice(2)}`, 
                    name: newCategoryName.trim(), 
                    isCustom: true, // Assuming categories added this way are custom
                    items: [] 
                };
                 if (!this.state.currentChecklistData.categories) this.state.currentChecklistData.categories = []; // Ensure categories array exists
                this.state.currentChecklistData.categories.push(newCategory);
                this.buildChecklistUI(this.state.currentChecklistData); // Re-render
                this.handleSaveChecklist(true); // Force save
            },
             handleDeleteChecklist() {
                 if (!this.state.currentChecklistData?.id || !this.firebase.db) return;
                  const checklistsCollectionPath = `artifacts/${this.firebase.appId}/checklists`; 
                 this.openConfirmationModal(
                     "Delete Checklist?",
                     `Are you sure you want to permanently delete the "${this.state.currentChecklistData.orgName || 'Untitled Checklist'}" checklist? This cannot be undone.`,
                     async () => {
                         try {
                              const docPath = `${checklistsCollectionPath}/${this.state.currentChecklistData.id}`;
                             await deleteDoc(doc(this.firebase.db, docPath));
                             console.log(`[Firestore] Checklist ${this.state.currentChecklistData.id} deleted.`);
                             
                             // Clear current view and go back to list
                             this.state.currentChecklistData = null; 
                             if (this.state.currentChecklistUnsubscribe) {
                                 this.state.currentChecklistUnsubscribe();
                                 this.state.currentChecklistUnsubscribe = null;
                             }
                             this.showChecklistSubView('list');
                             this.listenForChecklists(); // Refresh list view
                         } catch (error) {
                             console.error("[Firestore] Error deleting checklist:", error);
                             this.showStatus(this.elements.statusMessage, `Error deleting: ${error.message}`, 'error');
                         }
                     }
                 );
             },
              handleManageSharing() {
                 if (!this.state.currentChecklistData?.id) {
                     this.showToast("Cannot share an unsaved checklist.", "error");
                     return;
                 }
                 this.populateMembersList(); // Load current members into the modal
                  if (this.elements.shareStatusMessage) this.elements.shareStatusMessage.textContent = ''; // Clear previous status
                 this.openModal(this.elements.manageShareModal);
             },
             
             async populateMembersList() {
                 if (!this.elements.shareMembersList || !this.state.currentChecklistData) return;
                const listEl = this.elements.shareMembersList;
                listEl.innerHTML = '<div class="text-center text-sm text-gray-500">Loading members...</div>'; // Loading state
                
                const members = this.state.currentChecklistData.members || {};
                const memberIds = Object.keys(members);

                // Fetch display names if available
                const userProfiles = await this.fetchUserProfiles(memberIds);

                listEl.innerHTML = ''; // Clear loading/previous content

                if (memberIds.length === 0) {
                    listEl.innerHTML = '<div class="text-center text-sm text-gray-500">Only you have access.</div>';
                    return;
                }

                memberIds.forEach((id) => {
                    const role = members[id];
                    const profile = userProfiles[id];
                    const displayName = profile?.displayName || `User (${id.substring(0, 6)}...)`; // Fallback display name
                    const isSelf = id === this.state.userId;
                    const isOwner = role === 'owner';
                    
                    listEl.innerHTML += `
                        <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded-md text-sm">
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-800 dark:text-gray-200">${displayName} ${isSelf ? '(You)' : ''}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${id}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                               <span class="text-xs font-semibold uppercase px-2 py-0.5 rounded bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200">${role}</span>
                               ${(!isOwner && this.state.currentChecklistData.members[this.state.userId] === 'owner') ? 
                               `<button class="remove-member-btn p-1 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50" data-member-id="${id}" aria-label="Remove member ${displayName}">
                                   <i data-lucide="x-circle" class="w-4 h-4"></i>
                                </button>` : ''}
                            </div>
                         </div>`;
                 });
                 lucide.createIcons(); // Re-render icons after adding HTML
             },
             
             // Helper to fetch user profiles (if needed for display names)
             async fetchUserProfiles(userIds) {
                 if (!this.firebase.db || userIds.length === 0) return {};
                 const profiles = {};
                 const idsToFetch = userIds.filter(id => !this.state.allUsersCache[id]); // Fetch only if not cached

                 if (idsToFetch.length > 0) {
                     const userDocPromises = idsToFetch.map(id => {
                        const userDocPath = `artifacts/${this.firebase.appId}/users/${id}`;
                        return getDoc(doc(this.firebase.db, userDocPath));
                     });
                     try {
                        const userDocs = await Promise.all(userDocPromises);
                        userDocs.forEach(doc => {
                            if (doc.exists()) {
                                this.state.allUsersCache[doc.id] = doc.data(); // Cache the data
                            } else {
                                 this.state.allUsersCache[doc.id] = null; // Cache null if doc doesn't exist
                            }
                        });
                     } catch (error) {
                         console.error("[Firestore] Error fetching user profiles:", error);
                         // Don't block UI, just might show IDs instead of names
                     }
                 }
                
                // Populate result from cache
                userIds.forEach(id => {
                    profiles[id] = this.state.allUsersCache[id]; 
                });
                return profiles;
            },


             openModal(modalElement) {
                if(modalElement) modalElement.style.display = 'block';
             },

             handleAccordionClick(e) {
                // Combined handler for accordion toggle and copy buttons
                const accordionButton = e.target.closest('button.accordion-header');
                const copyButton = e.target.closest('.copy-link-btn, .copy-all-btn'); // Select both types

                if (accordionButton && !copyButton) { // Ensure it's the accordion toggle, not a copy button inside it
                    const targetId = accordionButton.dataset.target;
                    if (!targetId) return; 
                    const content = document.getElementById(targetId);
                    const chevron = accordionButton.querySelector('.chevron-icon');
                    const isExpanded = accordionButton.getAttribute('aria-expanded') === 'true';
                    
                    accordionButton.setAttribute('aria-expanded', !isExpanded);
                    if(content) content.classList.toggle('open');
                    if(chevron) chevron.classList.toggle('rotate-180');
                } else if (copyButton) {
                     // Handle copy actions
                     e.stopPropagation(); // Prevent accordion toggle if copy button is inside header
                     const textToCopy = copyButton.dataset.link || copyButton.dataset.links; // Get single link or all links
                    if (textToCopy) {
                         this.copyToClipboard(textToCopy, copyButton);
                    }
                 } else {
                    // Track link clicks if it's an anchor tag
                    const link = e.target.closest('a');
                    if(link) {
                        link.classList.add('visited-link');
                    }
                 }
            },
            
            showToast(message, type = 'success') {
                 if (!this.elements.toastContainer) return;
                const toast = document.createElement('div');
                const icon = type === 'success' ? 'check-circle' : 'alert-circle'; // Use different icon for errors
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
                this.elements.toastContainer.appendChild(toast);
                lucide.createIcons();
                setTimeout(() => toast.classList.add('show'), 10); // Fade in
                setTimeout(() => {
                    toast.classList.remove('show'); // Start fade out
                    toast.addEventListener('transitionend', () => toast.remove()); // Remove from DOM after fade out
                }, 3000);
            },
            
            // Helper function for clipboard copy
            copyToClipboard(text, button) {
                navigator.clipboard.writeText(text).then(() => {
                    const isCopyAll = button.classList.contains('copy-all-btn');
                    this.showToast(isCopyAll ? 'All links copied!' : 'Link copied!');
                    
                    const originalIconHTML = button.innerHTML;
                    button.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-green-500"></i>`; // Success icon
                    lucide.createIcons();
                    setTimeout(() => {
                        button.innerHTML = originalIconHTML; // Restore original icon
                        lucide.createIcons();
                    }, 1500);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    this.showToast('Failed to copy!', 'error');
                });
            },
            
            populateStates() {
                 if (!this.data.states || !this.elements.stateSelect) return;
                const fragment = document.createDocumentFragment();
                // Sort states alphabetically by name for better UX
                const sortedStates = Object.entries(this.data.states).sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB));

                for (const [abbr, name] of sortedStates) {
                    const option = document.createElement('option');
                    option.value = abbr;
                    option.textContent = name;
                    fragment.appendChild(option);
                }
                 this.elements.stateSelect.innerHTML = '<option value="">Select a State (Optional)</option>'; 
                this.elements.stateSelect.appendChild(fragment);
            },
            
            createAccordionSectionHTML(id, title, icon, links, isOpen = false) {
                if (!links || links.length === 0) return '';
                const linksHtml = links.map(link => this.createLinkHTML(link.name, link.url)).join('');
                 // Prepare links for copy-all button
                 const allLinksText = links.map(l => `${l.name}: ${l.url}`).join('\n'); 

                return `
                    <div class="card overflow-hidden">
                        <h2>
                            <button class="accordion-header w-full" aria-expanded="${isOpen}" data-target="${id}-content">
                                <span class="flex items-center space-x-3 text-left"> {/* Added text-left */}
                                    <i data-lucide="${icon}" class="w-6 h-6 text-indigo-500 flex-shrink-0"></i> {/* Added flex-shrink-0 */}
                                    <span class="text-xl font-semibold">${title}</span>
                                </span>
                                <span class="flex items-center space-x-3">
                                    <button class="copy-all-btn p-1 rounded text-gray-400 hover:text-indigo-500" data-links="${allLinksText}" title="Copy all links in this section" aria-label="Copy all links in the ${title} section">
                                        <i data-lucide="copy-plus" class="w-5 h-5"></i>
                                    </button>
                                    <i data-lucide="chevron-down" class="chevron-icon ${isOpen ? 'rotate-180' : ''} transition-transform duration-300"></i>
                                </span>
                            </button>
                        </h2>
                        <div id="${id}-content" role="region" class="accordion-content px-5 pb-5 ${isOpen ? 'open' : ''} transition-all duration-500 ease-in-out">
                            <div class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">${linksHtml}</div>
                        </div>
                    </div>`;
            },
            
            createLinkHTML(text, href) {
                 // Basic URL validation (check for http/https)
                 const isValidUrl = href && (href.startsWith('http://') || href.startsWith('https://'));
                 const linkAttributes = isValidUrl 
                    ? `href="${href}" target="_blank" rel="noopener noreferrer"` 
                    : `href="#" aria-disabled="true" title="Invalid URL provided"`; // Make non-functional if URL is bad
                 const linkColor = isValidUrl ? "text-indigo-500 hover:text-indigo-600" : "text-gray-400 cursor-not-allowed";
                 const copyButtonDisabled = !isValidUrl ? "disabled" : "";

                return `
                    <div class="result-link-card">
                        <a ${linkAttributes} class="flex-grow font-medium text-gray-700 dark:text-gray-200 truncate pr-4 ${!isValidUrl ? 'opacity-50' : ''}">${text}</a>
                        <div class="flex items-center space-x-2 flex-shrink-0"> {/* Added flex-shrink-0 */}
                            <a ${linkAttributes} class="${linkColor}" aria-label="Open link for ${text} ${isValidUrl ? 'in new tab' : '(Invalid URL)'}">
                               <i data-lucide="${isValidUrl ? 'arrow-up-right' : 'alert-circle'}" class="w-5 h-5"></i>
                            </a>
                            <button class="copy-link-btn p-1 rounded text-gray-400 hover:text-indigo-500" data-link="${href}" title="Copy link" aria-label="Copy link for ${text}" ${copyButtonDisabled}>
                                <i data-lucide="copy" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>`;
            },
            getChecklistMasterTemplate() {
                // Return a deep copy to prevent mutation of the original template
                return JSON.parse(JSON.stringify([
                    { id: "cat_fed_state", name: "Federal & State Compliance", isCustom: false, items: [
                        { id: "fed_irs_status", text: "IRS 501(c)(3) status verified?", link: "https://apps.irs.gov/app/eos/", linkText: "IRS Search", isCustom: false, checked: false, notes: "" },
                        { id: "fed_form_990", text: "IRS Form 990 accessible & reviewed?", link: "https://projects.propublica.org/nonprofits/search?q=", linkText: "ProPublica Search", isCustom: false, checked: false, notes: "" },
                        { id: "rep_bbb_rating", text: "Better Business Bureau (BBB) rating checked?", link: "https://www.bbb.org/search?find_text=", linkText: "BBB Search", isCustom: false, checked: false, notes: "" },
                         // Added more detailed items based on your animal_checklist_app/index.html
                         { id: "fed_aphis_license", text: "APHIS license status verified (if applicable)?", link: "https://aphis.my.site.com/PublicSearchTool/s/", linkText: "APHIS Search", isCustom: false, checked: false, notes: "" },
                         { id: "state_charity_reg", text: "Registered with State Charity Officials?", link: "https://www.nasconet.org/resources/state-government/", linkText: "NASCO Directory", isCustom: false, checked: false, notes: "" },
                         { id: "state_local_licenses", text: "Necessary state/local animal shelter/rescue licenses obtained?", isCustom: false, checked: false, notes: "" }
                    ]},
                     { id: "cat_operational_trans", name: "Operational Transparency", isCustom: false, items: [
                        { id: "op_legal_dba_name", text: "Legal name and DBA (Doing Business As) are clearly stated?", isCustom: false, checked: false, notes: "" },
                        { id: "op_contact_info", text: "Verifiable contact information (phone/email) is available and responsive?", isCustom: false, checked: false, notes: "" },
                        { id: "op_website_mission", text: "Website clearly states mission, programs, and animal welfare practices?", isCustom: false, checked: false, notes: "" },
                        { id: "op_board_list", text: "A list of the Board of Directors is publicly available?", isCustom: false, checked: false, notes: "" },
                        { id: "op_adoption_process", text: "Adoption process is clearly documented and transparent?", isCustom: false, checked: false, notes: "" },
                        { id: "op_sourcing_policy", text: "Animal sourcing policy (where animals come from) is clear?", isCustom: false, checked: false, notes: "" },
                        { id: "op_medical_records", text: "Comprehensive medical records (vaccinations, spay/neuter) are provided with adoptions?", isCustom: false, checked: false, notes: "" }
                    ]},
                     { id: "cat_reputation_acc", name: "Reputation & Accountability", isCustom: false, items: [
                        // BBB moved to federal/state section
                         { id: "rep_watchdog_sites", text: "Charity watchdog sites (e.g., Charity Navigator, GuideStar) reviewed?", link: "https://www.charitynavigator.org/", linkText: "Charity Navigator", isCustom: false, checked: false, notes: "" },
                         { id: "rep_news_archives", text: "News archives and search engines checked for significant negative press or legal issues?", isCustom: false, checked: false, notes: "" }
                    ]}
                ]));
            },
            
             setSaveButtonState(isSaving) {
                 if (!this.elements.saveChecklistBtn || !this.elements.saveButtonText || !this.elements.saveSpinner) return;
                this.elements.saveButtonText.textContent = isSaving ? 'Saving...' : 'Save';
                this.elements.saveSpinner.classList.toggle('hidden', !isSaving);
                this.elements.saveChecklistBtn.disabled = isSaving;
            },
            
            showStatus(element, message, type = 'success', duration = 3000) {
                 if (!element) {
                    console.warn(`Attempted to show status "${message}" on a null element.`);
                    return; 
                }
                const colors = { success: 'text-green-600', error: 'text-red-600', info: 'text-gray-600' };
                const darkColors = { success: 'dark:text-green-400', error: 'dark:text-red-400', info: 'dark:text-gray-400' };
                element.textContent = message;
                element.className = `mt-4 text-center font-medium ${colors[type] || colors.info} ${darkColors[type] || darkColors.info}`; 
                
                 // Clear previous timeout if exists
                 if (element._statusTimeout) clearTimeout(element._statusTimeout); 

                 if (duration !== null) {
                    element._statusTimeout = setTimeout(() => {
                        if (element.textContent === message) { // Only clear if message hasn't changed
                             element.textContent = '';
                             element.className = 'mt-4 text-center font-medium'; 
                        }
                         delete element._statusTimeout; 
                     }, duration);
                 } else {
                      delete element._statusTimeout; // Ensure no timeout is pending if duration is null
                 }
            },
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
